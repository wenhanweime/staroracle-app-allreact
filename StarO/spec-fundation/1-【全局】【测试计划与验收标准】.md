# ğŸŒŒ StarO (é›†æ˜Ÿé—®é—®) - å…¨æ ˆæµ‹è¯•ä¸è´¨é‡ä¿éšœç™½çš®ä¹¦ V4.1 (å®Œæ•´èåˆç‰ˆ)

**æ ¸å¿ƒç†å¿µ**ï¼šåŸºäºè§„æ ¼é©±åŠ¨ (Spec-Driven) åŸåˆ™ï¼Œé’ˆå¯¹**â€œç˜¦å®¢æˆ·ç«¯ï¼Œå¯Œåç«¯â€**æ¶æ„ï¼Œå»ºç«‹è¦†ç›–åº•å±‚é€»è¾‘ã€AI è´¨é‡ã€å¼‚å¸¸è¾¹ç•ŒåŠè¿ç»´ç­–ç•¥çš„å…¨é“¾è·¯è´¨é‡é˜²å¾¡ä½“ç³»ã€‚

---

## 1. æµ‹è¯•æ¶æ„æ€»è§ˆ (Testing Architecture)

æµ‹è¯•åˆ†ä¸ºäº”ä¸ªå±‚çº§ï¼Œç¡®ä¿ä»åº•å±‚è®¡ç®—åˆ°æœ€ç»ˆç”¨æˆ·ä½“éªŒçš„å…¨é¢è´¨é‡ã€‚

| å±‚çº§   | æµ‹è¯•ç±»å‹                        | æ ¸å¿ƒå…³æ³¨ç‚¹                                    | ä¸»è¦å·¥å…·/æ¡†æ¶              | è´£ä»»æ–¹    |
| :----- | :------------------------------ | :-------------------------------------------- | :------------------------- | :-------- |
| **L1** | **å•å…ƒæµ‹è¯• (Unit)**             | æ ¸å¿ƒç®—æ³•ã€æ•°æ®è½¬æ¢ã€AI ä¸Šä¸‹æ–‡æ„å»ºé€»è¾‘         | Deno Test, XCTest          | å¼€å‘äººå‘˜  |
| **L2** | **é›†æˆæµ‹è¯• (Integration)**      | æ•°æ®åº“äº¤äº’ã€RLS æƒé™ã€æ˜Ÿæ˜Ÿæ¼”åŒ–çŠ¶æ€è§¦å‘        | Supabase Local, SQL Editor | å¼€å‘äººå‘˜  |
| **L3** | **AI è¯„ä¼° (Evaluation)**        | æ ‡ç­¾å‡†ç¡®åº¦ã€**AI åå°„å¥è´¨é‡**ã€è¶…æ–°æ˜Ÿçˆ†å‘è¯†åˆ« | Golden Dataset, è‡ªåŠ¨åŒ–è„šæœ¬ | äº§å“/å¼€å‘ |
| **L4** | **ç«¯åˆ°ç«¯æµ‹è¯• (E2E)**            | å®Œæ•´ç”¨æˆ·è·¯å¾„ã€**å¼‚å¸¸è¾¹ç•Œ**ã€æ„Ÿå®˜å¾®åé¦ˆ        | çœŸæœº/æ¨¡æ‹Ÿå™¨, æ‰‹åŠ¨ QA       | QA/ç”¨æˆ·   |
| **L5** | **éåŠŸèƒ½æµ‹è¯• (Non-Functional)** | æ¸²æŸ“æ€§èƒ½ã€å†·å¯åŠ¨å»¶è¿Ÿã€å®‰å…¨çº¢çº¿                | Instruments, æŠ“åŒ…å·¥å…·      | æ¶æ„å¸ˆ    |

---

## 2. L1: æ ¸å¿ƒé€»è¾‘å•å…ƒæµ‹è¯• (Unit Tests)

### 2.1 Edge Functions å¯¹è¯ç®¡ç†é€»è¾‘ (`/api/chat/send`)

**ç›®æ ‡**ï¼šç¡®ä¿å¤åˆ»è‡ª NextChat çš„åˆ†å±‚è®°å¿†æ¶æ„å‡†ç¡®æ— è¯¯ï¼Œä¸”èƒ½æ­£ç¡®è®¡ç®—é“¸æ˜Ÿæ‰€éœ€æŒ‡æ ‡ã€‚

| ID        | æµ‹è¯•ç”¨ä¾‹å             | è¾“å…¥æ•°æ® (Mock)                                                                          | é¢„æœŸæ–­è¨€ (Assert)                                                                          |
| :-------- | :--------------------- | :--------------------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------- |
| **BU-01** | **ä¸Šä¸‹æ–‡æ»‘åŠ¨çª—å£æˆªæ–­** | æ„é€  `history` åŒ…å«è¶…é™ Token çš„æ¶ˆæ¯ã€‚                                                   | 1. è¾“å‡ºçš„ä¸Šä¸‹æ–‡åˆ—è¡¨é•¿åº¦è¢«æˆªæ–­ï¼Œä½† `system_prompt` å’Œ `memory_prompt`ï¼ˆé•¿æœŸè®°å¿†ï¼‰å¿…é¡»ä¿ç•™ã€‚ |
| **BU-02** | **è‡ªåŠ¨æ‘˜è¦è§¦å‘å™¨**     | è¾“å…¥ `last_summarize_index = 10`, å½“å‰ `total_messages = 25`ã€‚                           | å‡½æ•° `shouldTriggerSummary` è¿”å› `true`ã€‚                                                  |
| **BU-07** | **æ·±åº¦æŒ‡æ ‡è®¡ç®—å‡†ç¡®æ€§** | è¾“å…¥åŒ…å« 15 ä¸ªé—®ç­”å¯¹ï¼ˆ`QA_Pairs`ï¼‰ï¼Œå…¶ä¸­ 7 ä¸ªæ˜¯æ·±åº¦è§‰å¯Ÿé—®ç­”å¯¹ï¼ˆ`Reflection_QA_Pairs`ï¼‰ã€‚ | é“¸æ˜Ÿæ¥å£è°ƒç”¨æ—¶ï¼Œè¿”å›å‚æ•° `QA_Pairs_Count = 15`ï¼Œ`Reflection_QA_Pairs_Count = 7`ã€‚          |

### 2.2 é“¸æ˜Ÿå·¥å‚é€»è¾‘ (`/api/star/cast`)

**ç›®æ ‡**ï¼šç¡®ä¿æ•°æ®ç”Ÿæˆçš„æ ¼å¼æ­£ç¡®æ€§å’Œ**å†…åœ¨å®‡å®™æ³•åˆ™**çš„ç¡®å®šæ€§ã€‚

| ID        | æµ‹è¯•ç”¨ä¾‹å         | è¾“å…¥æ•°æ® (Mock)                                         | é¢„æœŸæ–­è¨€ (Assert)                                                                                          |
| :-------- | :----------------- | :------------------------------------------------------ | :--------------------------------------------------------------------------------------------------------- |
| **BU-04** | **åæ ‡ç®—æ³•ç¡®å®šæ€§** | è®¾å®š `galaxy_seed`, `star_arm_assignment = "emotion"`ã€‚ | 1. é‡å¤è°ƒç”¨ 100 æ¬¡ï¼Œè¿”å›çš„ `{x, y, z}` åæ ‡å¿…é¡»ä½çº§ä¸€è‡´ã€‚ 2. åæ ‡å¿…é¡»è½åœ¨ "emotion" å¯¹åº”çš„æ—‹è‡‚è§’åº¦åŒºé—´å†…ã€‚ |
| **BU-08** | **æ˜Ÿå¡ç­‰çº§åˆå§‹å®šçº§** | è¾“å…¥ `Reflection_QA_Pairs_Count = 1` vs `10`ã€‚          | å‰è€…æ˜Ÿå¡ç­‰çº§ä½äºåè€…ï¼›é“¶æ²³äº®åº¦ä¸ä½œä¸ºåç«¯éªŒæ”¶é¡¹ã€‚                                                          |
| **BU-09** | **è¶…æ–°æ˜Ÿåˆå§‹çŠ¶æ€** | è¾“å…¥ AI è¯†åˆ«å‡ºçš„â€œé‡å¤§çªç ´â€æ ‡ç­¾ã€‚                        | `evolution_status` å­—æ®µè¢«è®¾ç½®ä¸º `Supernova`ï¼Œä¸” `has_nebula` å­—æ®µä¸º `True`ã€‚                               |

---

## 3. L2: æ•°æ®åº“ä¸æ¼”åŒ–é›†æˆæµ‹è¯• (Integration Tests)

### 3.1 æ•°æ®éš”ç¦»ä¸å®Œæ•´æ€§

**ç›®æ ‡**ï¼šç¡®ä¿ RLS ç”Ÿæ•ˆï¼Œä¸”æ ¸å¿ƒæ•°æ®åœ¨è§¦å‘å™¨ä¸‹è‡ªåŠ¨ç”Ÿæˆã€‚

| ID        | æµ‹è¯•åœºæ™¯             | æ“ä½œ                                           | é¢„æœŸç»“æœ                                                                  |
| :-------- | :------------------- | :--------------------------------------------- | :------------------------------------------------------------------------ |
| **DI-01** | **æ–°ç”¨æˆ·åˆå§‹åŒ–**     | å‘ `auth.users` æ’å…¥æ–°è¡Œã€‚                     | `public.profiles` è¡¨è‡ªåŠ¨ç”Ÿæˆä¸€è¡Œï¼Œä¸” `galaxy_seed` (éšæœºç§å­) ä¸ä¸º NULLã€‚ |
| **DI-03** | **RLS è·¨ç”¨æˆ·æŸ¥è¯¢**   | ç”¨æˆ· A å°è¯•æŸ¥è¯¢ç”¨æˆ· B çš„ `stars`ã€‚             | ç»“æœé›†å¿…é¡»ä¸ºç©ºï¼ˆRow Level Security ç”Ÿæ•ˆï¼‰ã€‚                               |
| **DI-04** | **æ˜Ÿæ˜Ÿæ¼”åŒ–çŠ¶æ€æ›´æ–°** | è°ƒç”¨ `/api/star/evolve` æ¥å£ï¼Œè¾“å…¥ `star_id`ã€‚ | æ•°æ®åº“ä¸­ `stars.evolution_status` ç”± `Nova` å˜æ›´ä¸º `Main Sequence Star`ã€‚ |

### 3.2 é•¿æœŸè®°å¿†ä¸æŒ‡æ ‡é›†æˆ

**ç›®æ ‡**ï¼šéªŒè¯ NextChat è®°å¿†ç­–ç•¥çš„åç«¯è½åœ°ã€‚

| ID        | æµ‹è¯•åœºæ™¯         | æ“ä½œ                                       | é¢„æœŸç»“æœ                                                                      |
| :-------- | :--------------- | :----------------------------------------- | :---------------------------------------------------------------------------- |
| **DI-05** | **è‡ªåŠ¨æ‘˜è¦æ›´æ–°** | è§¦å‘ `api/chat/summarize` å¼‚æ­¥ä»»åŠ¡ã€‚       | `chats.memory_prompt` æ›´æ–°ä¸º LLM ç”Ÿæˆçš„æ‘˜è¦ï¼Œä¸” `last_summarize_index` å¢åŠ ã€‚ |
| **DI-06** | **å¯¹è¯è·¨åº¦è®°å½•** | ç”¨æˆ·åœ¨ 3 å¤©å†…ä¸åŒä¸€ `chat_id` äº’åŠ¨å¹¶é“¸æ˜Ÿã€‚ | `stars.Conversation_Days_Span` å­—æ®µå€¼åº” > 1ã€‚                                 |

---

## 4. L3: AI æ•ˆæœä¸è´¨é‡è¯„ä¼° (AI Evaluation)

**ç›®æ ‡**ï¼šè¯„ä¼° AI è¾“å‡ºçš„éç¡®å®šæ€§å†…å®¹è´¨é‡ï¼Œç‰¹åˆ«æ˜¯æƒ…æ„Ÿå¾®åé¦ˆã€‚

| ID        | æµ‹è¯•ç”¨ä¾‹å           | è¯„ä¼°æŒ‡æ ‡                                   | é»„é‡‘æ ‡å‡† (Golden Standard)                                                                                                       |
| :-------- | :------------------- | :----------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------- |
| **AE-01** | **AI åå°„å¥è´¨é‡**    | **å…±æƒ…åº¦ä¸è¯—æ„åº¦**ã€‚                       | è¾“å…¥ï¼šâ€œæˆ‘æœ€è¿‘å·¥ä½œéå¸¸ä¸é¡ºï¼Œæ„Ÿè§‰å‹åŠ›å¿«æŠŠæˆ‘å‹å®äº†ã€‚â€é»„é‡‘æ ‡å‡†è¾“å‡ºï¼šâ€œä½ åˆšåˆšé¢å¯¹äº†ä¸€ä¸ªæƒ…ç»ªæ³¢åŠ¨çš„ç¬é—´ï¼Œè¿™ç§å‹‡æ°”ï¼Œå€¼å¾—ä¸€é¢—å…‰äº®çš„æ˜Ÿæ˜Ÿã€‚â€ |
| **AE-02** | **è¶…æ–°æ˜Ÿè§¦å‘å‡†ç¡®ç‡** | **é‡å¤§è®¤çŸ¥çªç ´è¯†åˆ«ç‡**ã€‚                   | AI å¿…é¡»åœ¨ > 90% çš„æµ‹è¯•ç”¨ä¾‹ä¸­å‡†ç¡®è¯†åˆ«å¹¶è¿”å›è§¦å‘è¶…æ–°æ˜Ÿçš„æ ‡è®°ã€‚                                                                     |
| **AE-03** | **æƒ…ç»ªæ ‡ç­¾å‡†ç¡®æ€§**   | **Primary_Emotion** å­—æ®µä¸æ–‡æœ¬æƒ…æ„Ÿå»åˆåº¦ã€‚ | è¾“å…¥ï¼šâ€œæˆ‘æˆåŠŸæ‹¿åˆ°äº† offerï¼Œæ„Ÿè§‰ä¸€åˆ‡çš„åŠªåŠ›éƒ½å€¼äº†ï¼â€ã€‚é»„é‡‘æ ‡å‡†æ ‡ç­¾ï¼š`"Joy"`/`"Satisfaction"`ã€‚                                     |
| **AE-04** | **è‡ªåŠ¨æ‘˜è¦æ— å¹»è§‰**   | æ‘˜è¦å‹ç¼©è´¨é‡ã€‚                             | å®šæœŸæŠ½æ£€ `chats.memory_prompt`ï¼Œç¡®ä¿æ‘˜è¦ä¸å‘ç”Ÿ**ä¿¡æ¯å¹»è§‰**æˆ–**å…³é”®ä¿¡æ¯é—å¿˜**ã€‚                                                   |

---

## 5. L4: å…³é”®è·¯å¾„ä¸å¼‚å¸¸è¾¹ç•Œæµ‹è¯• (E2E Tests)

**ç›®æ ‡**ï¼šéªŒè¯å®Œæ•´ç”¨æˆ·è·¯å¾„ã€å¤šç«¯åŒæ­¥ï¼Œä»¥åŠåœ¨**æç«¯æƒ…å†µ**ä¸‹çš„ç³»ç»Ÿé²æ£’æ€§ã€‚

### 5.1 æ­£å¸¸è·¯å¾„ (Happy Path)

| ID         | åœºæ™¯ (Scenario)         | æ­¥éª¤ (Steps)                                                               | æˆåŠŸæ ‡å‡† (Pass Criteria)                                                                                            |
| :--------- | :---------------------- | :------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------ |
| **E2E-01** | **è§‰å¯Ÿé—­ç¯ä¸å¾®åé¦ˆ**    | 1. ç”¨æˆ·æé—®å¹¶å¤šè½®å¯¹è¯ã€‚2. ç»“æŸæ—¶è¯„çº§ 5 æ˜Ÿã€‚                                | 1. å¯¹è¯æµç•…ï¼ŒAI åå°„å¥å³æ—¶å‡ºç°ã€‚ 2. è§¦å‘â€œæ–‡å­—è½¬æ˜Ÿâ€åŠ¨ç”»ã€‚ 3. æ˜Ÿæ˜Ÿé£å…¥æ­£ç¡®æ‚¬è‡‚ä½ç½®ã€‚ 4. æ‰‹æœºäº§ç”Ÿç²¾ç»†åŒ–çš„éœ‡åŠ¨åé¦ˆã€‚    |
| **E2E-04** | **æ‘˜æ˜Ÿæ¨¡å¼ - éšé£è€Œé€** | 1. ç‚¹å‡»æ˜Ÿç©ºè§¦å‘â€œçµæ„Ÿæ‘˜æ˜Ÿâ€å¡ç‰‡ã€‚2. ç”¨æˆ·å‘ä¸Šåˆ’èµ°å¡ç‰‡ã€‚                       | 1. å¡ç‰‡å†…å®¹æ¥è‡ª `inspiration_source`ã€‚ 2. å¡ç‰‡ä¼˜é›…åœ°åˆ†è§£æˆã€æ˜Ÿå°˜ã€‘åŠ¨ç”»ã€‚ 3. **æœªåœ¨** `stars` è¡¨ä¸­ç”Ÿæˆæ–°çš„è§‰å¯Ÿå¡ç‰‡ã€‚ |
| **E2E-05** | **æ‘˜æ˜Ÿæ¨¡å¼ - æ·±å…¥å¯¹è¯** | 1. ç‚¹å‡»æ˜Ÿç©ºè§¦å‘å¡ç‰‡ã€‚2. ç‚¹å‡»ã€æˆ‘æƒ³èŠèŠã€‘æŒ‰é’®ã€‚3. è¿›è¡Œ 3 è½®ä»¥ä¸Šå¯¹è¯å¹¶ç»“æŸã€‚ | 1. AI ç«‹å³ä»¥è¯¥å¡ç‰‡ä¸ºå¼•å­å¼€å¯å¯¹è¯ã€‚ 2. æœ€ç»ˆç”Ÿæˆä¸€é¢—å¸¦æœ‰è¯¥å¡ç‰‡æ ‡ç­¾çš„**æ–°æ˜Ÿ**ã€‚                                        |
| **E2E-06** | **è¶…æ–°æ˜Ÿçˆ†å‘ä½“éªŒ**      | 1. è¾“å…¥æå…·æƒ…æ„Ÿé‡Šæ”¾çš„è§‰å¯Ÿã€‚2. AI æè®®æ ‡è®°ä¸ºâ€œè¶…æ–°æ˜Ÿâ€ã€‚                      | 1. ç¡®è®¤åï¼Œæ˜Ÿç©ºç•™ä¸‹æ°¸ä¹…çš„**â€œæ˜Ÿäº‘â€**èƒŒæ™¯ã€‚ 2. è§¦å‘æ‚ è¿œè€Œéœ‡æ’¼çš„éŸ³æ•ˆä¸å¼ºçƒˆçš„è§¦æ„Ÿåé¦ˆã€‚                                 |
| **E2E-07** | **å¤šç«¯åŒæ­¥**            | 1. iPhone A é“¸æ˜Ÿã€‚2. è§‚å¯Ÿ iPhone B (åŒè´¦å·)ã€‚                              | iPhone B åœ¨ 5ç§’å†… è‡ªåŠ¨æ˜¾ç¤ºæ–°æ˜Ÿæ˜Ÿï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°ã€‚                                                                    |

### 5.2 å¼‚å¸¸ä¸è¾¹ç•Œè·¯å¾„ (Edge Cases)

| ID         | åœºæ™¯ (Scenario)         | æ­¥éª¤ (Steps)                          | é¢„æœŸç»“æœ (Expected Result)                                                                                                                   |
| :--------- | :---------------------- | :------------------------------------ | :------------------------------------------------------------------------------------------------------------------------------------------- |
| **E2E-10** | **ç½‘ç»œå¼‚å¸¸ - å¯¹è¯ä¸­æ–­** | åœ¨ AI æµå¼å›å¤è¿‡ç¨‹ä¸­æ–­å¼€ç½‘ç»œã€‚        | App åº”æç¤ºâ€œè¿æ¥ä¸­æ–­â€ï¼Œä¿ç•™å·²æ¥æ”¶çš„æ–‡æœ¬ï¼Œå¹¶å…è®¸åœ¨é‡è¿åé‡è¯•å‘é€ï¼Œä¸åº” Crashã€‚                                                                 |
| **E2E-11** | **ç½‘ç»œå¼‚å¸¸ - é“¸æ˜Ÿä¸­æ–­** | åœ¨â€œæ–‡å­—è½¬æ˜Ÿâ€åŠ¨ç”»æ’­æ”¾æ—¶æ–­ç½‘ã€‚          | åç«¯äº‹åŠ¡åº”ä¿è¯åŸå­æ€§ï¼ˆè¦ä¹ˆæˆåŠŸç”Ÿæˆå¹¶è¿”å›ï¼Œè¦ä¹ˆå¤±è´¥ï¼‰ã€‚å‰ç«¯é‡è¿ååº”èƒ½é‡æ–°æ‹‰å–åˆ°è¯¥æ˜Ÿæ˜Ÿï¼ˆå¦‚æœåç«¯æˆåŠŸï¼‰æˆ–æç¤ºé‡è¯•ï¼ˆå¦‚æœå¤±è´¥ï¼‰ï¼Œé¿å…â€œå¹½çµæ˜Ÿæ˜Ÿâ€ã€‚ |
| **E2E-12** | **åç«¯å†·å¯åŠ¨**          | Edge Function ä¼‘çœ åé¦–æ¬¡è°ƒç”¨ã€‚        | å®¢æˆ·ç«¯éœ€æœ‰ä¼˜é›…çš„ **Loading çŠ¶æ€**ï¼ˆå¦‚æ˜Ÿå…‰å‘¼å¸åŠ¨ç”»ï¼‰ï¼Œå»¶è¿Ÿä¸è¶…è¿‡ 3ç§’ï¼Œä¸åº”æ˜¾ç¤ºâ€œè¯·æ±‚è¶…æ—¶â€ã€‚                                                    |
| **E2E-13** | **ç©ºåº“å…œåº•**            | `inspiration_source` ä¸ºç©ºæ—¶è§¦å‘æ‘˜æ˜Ÿã€‚ | æ‘˜æ˜ŸåŠ¨ä½œåº”æœ‰å…œåº•æ–‡æ¡ˆï¼ˆå¦‚â€œæ˜Ÿç©ºé™æ‚„æ‚„ï¼Œéƒ½åœ¨æ²‰ç¡...â€ï¼‰ï¼Œä¸åº”å¼¹ç©ºçª—æˆ–é—ªé€€ã€‚                                                                      |
| **E2E-14** | **å¹¶å‘é˜²æŠ–**            | å¿«é€Ÿè¿ç»­ç‚¹å‡»â€œå‘é€â€æˆ–â€œæ‘˜æ˜Ÿâ€ã€‚          | æŒ‰é’®åº”åœ¨ç¬¬ä¸€æ¬¡ç‚¹å‡»åç«‹å³ Disable æˆ–å¿½ç•¥åç»­ç‚¹å‡»ï¼Œåªè§¦å‘ä¸€æ¬¡è¯·æ±‚ã€‚                                                                            |

---

## 6. L5: éåŠŸèƒ½æµ‹è¯• (Non-Functional Tests)

### 6.1 æ€§èƒ½æŒ‡æ ‡ (Performance)

**ç›®æ ‡**ï¼šç¡®ä¿ Swift å®¢æˆ·ç«¯æ¸²æŸ“æµç•…ï¼Œä¸” Edge Functions å“åº”è¿…é€Ÿã€‚

| æŒ‡æ ‡                | é˜ˆå€¼                                               | æµ‹è¯•å·¥å…·                        |
| :------------------ | :------------------------------------------------- | :------------------------------ |
| **æ˜Ÿç©ºæ¸²æŸ“å¸§ç‡**    | iPhone 12 åŠä»¥ä¸Š **> 55 FPS** (æ¸²æŸ“ 2000 é¢—æ˜Ÿæ—¶)ã€‚ | Xcode Instruments (Metal Trace) |
| **å†·å¯åŠ¨å»¶è¿Ÿ**      | Edge Function é¦–æ¬¡å“åº” **< 3s**ã€‚                  | Postman è®¡æ—¶                    |
| **é¦–å­—æ—¶é—´ (TTFT)** | æµå¼å“åº”é¦–å­— **< 1.5s**ã€‚                          | å®¢æˆ·ç«¯æ—¥å¿—åŸ‹ç‚¹                  |
| **å†…å­˜å ç”¨**        | å³°å€¼ **< 300MB**ã€‚                                 | Xcode Memory Graph              |

### 6.2 å®‰å…¨çº¢çº¿ (Security Audit)

**ç›®æ ‡**ï¼šä¿æŠ¤ç”¨æˆ·æ•°æ®éšç§ï¼Œé˜²æ­¢ API å¯†é’¥æ³„éœ²ã€‚

| ID        | æµ‹è¯•ç”¨ä¾‹å       | æ“ä½œ                                                          | æˆåŠŸæ ‡å‡† (Pass Criteria)                                                                      |
| :-------- | :--------------- | :------------------------------------------------------------ | :-------------------------------------------------------------------------------------------- |
| **SE-01** | **API å¯†é’¥éš”ç¦»** | ä½¿ç”¨ Charles/ProxyMan æŠ“åŒ…æ£€æŸ¥æ‰€æœ‰ API è¯·æ±‚å¤´ã€‚               | è¯·æ±‚å¤´ä¸­åªæœ‰ `Authorization: Bearer SUPABASE_JWT`ã€‚**ç»ä¸èƒ½**å‡ºç° `sk-proj...` (OpenAI Key)ã€‚ |
| **SE-02** | **SQL æ³¨å…¥æ¸—é€** | åœ¨èŠå¤©è¾“å…¥æ¡†è¾“å…¥ SQL è¯­å¥ï¼ˆä¾‹å¦‚ `'; DROP TABLE stars; --`ï¼‰ã€‚ | Edge Function å¿…é¡»å°†å…¶è§†ä¸ºæ™®é€šæ–‡æœ¬å¤„ç†ï¼Œä¸”æ•°æ®åº“ä¸æ‰§è¡Œä»»ä½• SQL æ“ä½œã€‚                         |
| **SE-03** | **åŒ¿ååˆ†äº«è„±æ•** | ç”¨æˆ·ä½¿ç”¨â€œæ˜Ÿå…‰ä¿¡ä½¿â€åŠŸèƒ½åˆ†äº«å¡ç‰‡ã€‚                              | åˆ†äº«å›¾ç‰‡ä¸Šä»…åŒ…å«è§‰å¯Ÿæ–‡å­—å’Œæ˜Ÿæ˜Ÿå›¾å½¢ï¼Œ**ç»ä¸åŒ…å«**ä»»ä½•å¯è¯†åˆ«çš„ä¸ªäººä¿¡æ¯æˆ–ç”¨æˆ· IDã€‚               |

---

## 7. æµ‹è¯•æ‰§è¡Œä¸å‡†å…¥å‡†å‡º (Gatekeeping)

*   **å¼€å‘é˜¶æ®µ**ï¼šå¿…é¡»é€šè¿‡æ‰€æœ‰ **L1 å•å…ƒæµ‹è¯•** (Deno + Swift)ã€‚
*   **ææµ‹é˜¶æ®µ**ï¼šæ ¸å¿ƒåŠŸèƒ½ Happy Path (E2E-01, E2E-04, E2E-05) å¿…é¡»è·‘é€šï¼Œæ—  Crashã€‚
*   **å‘å¸ƒé˜¶æ®µ**ï¼šL1-L5 æ‰€æœ‰ P0 çº§æµ‹è¯•é€šè¿‡ï¼Œç‰¹åˆ«æ˜¯ RLS å®‰å…¨æµ‹è¯• (DI-03, SE-01) å¿…é¡» 100% é€šè¿‡ã€‚

---

## 8. ä¸Šçº¿ä¸è¿ç»´ç­–ç•¥ (Rollout & Operations)

### 8.1 ç°åº¦å‘å¸ƒç­–ç•¥ (Phased Rollout)

ç”±äºæ¶‰åŠåç«¯æ ¸å¿ƒé€»è¾‘å˜æ›´ï¼Œé‡‡ç”¨ **Feature Flag** é€æ­¥æ”¾é‡ï¼š

1.  **é˜¶æ®µä¸€ (Internal - 0%)**: 
    *   **å¯¹è±¡**: å†…éƒ¨å¼€å‘ä¸æµ‹è¯•äººå‘˜ (TestFlight Internal Group)ã€‚
    *   **ç›®æ ‡**: éªŒè¯ Seed ç”Ÿæˆçš„ç¡®å®šæ€§ã€RLS æƒé™åŠåŸºæœ¬åŠŸèƒ½é—­ç¯ã€‚
2.  **é˜¶æ®µäºŒ (Canary - 5%)**: 
    *   **å¯¹è±¡**: éšæœºé€‰å–çš„ 5% æ´»è·ƒç”¨æˆ·ã€‚
    *   **ç›®æ ‡**: ç›‘æ§ Supabase Dashboard ä¸­çš„ `Edge Function Invocation Errors` å’Œ `P95 Latency`ã€‚ç¡®ä¿æ— å¤§è§„æ¨¡æ€§èƒ½é€€åŒ–ã€‚
3.  **é˜¶æ®µä¸‰ (Full - 100%)**: 
    *   **å¯¹è±¡**: å…¨é‡ç”¨æˆ·ã€‚
    *   **ç›®æ ‡**: ç¨³å®šè¿è¡Œï¼ŒæŒç»­ç›‘æ§æˆæœ¬ä¸é”™è¯¯ç‡ã€‚

### 8.2 ç´§æ€¥å›æ»šæ¡ä»¶ (Rollback Conditions)

è‹¥ç›‘æ§åˆ°ä»¥ä¸‹ä»»ä¸€æƒ…å†µï¼Œç«‹å³è§¦å‘å›æ»šæµç¨‹ï¼š

1.  **æ•°æ®æ±¡æŸ“**: æ–°ç‰ˆæœ¬å¯¼è‡´ `stars` è¡¨åæ ‡æ•°æ®å¼‚å¸¸ï¼ˆå¦‚å…¨éƒ¨ä¸º 0 æˆ– NaNï¼‰ã€‚
2.  **æ€§èƒ½é›ªå´©**: `/api/chat/send` æ¥å£ P95 å»¶è¿Ÿè¶…è¿‡ **5ç§’**ï¼Œæˆ–é”™è¯¯ç‡è¶…è¿‡ **1%**ã€‚
3.  **å®‰å…¨æ¼æ´**: å‘ç° RLS ç­–ç•¥å¤±æ•ˆï¼Œç”¨æˆ·å¯è¶Šæƒè®¿é—®ã€‚
4.  **ä¸¥é‡å´©æºƒ**: iOS ç«¯å´©æºƒç‡æ¿€å¢è‡³ **> 0.5%**ã€‚

### 8.3 å›æ»šæ“ä½œæ‰‹å†Œ (Runbook)

*   **åç«¯å›æ»š**: åœ¨ Supabase Dashboard å°† Edge Function (`chat-send`, `star-cast`) å›æ»šè‡³ `Previous Deployment`ã€‚
*   **å‰ç«¯å›æ»š**: 
    *   TestFlight: åœæ­¢å½“å‰æ„å»ºçš„åˆ†å‘ï¼Œæ¢å¤ä¸Šä¸€æ„å»ºã€‚
    *   App Store: å¦‚æœå·²ä¸Šçº¿ï¼Œæäº¤ç´§æ€¥ä¿®å¤åŒ… (Hotfix) æˆ–ç”³è¯·åŠ æ€¥å®¡æ ¸å›æ»šã€‚
