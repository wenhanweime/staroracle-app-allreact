

这份文档将我们之前讨论的“集星问问 (StarO)”产品哲学、核心宇宙法则、技术架构以及精细化的用户体验设计进行全面汇总，作为开发阶段的正式蓝图。

---

## 3. 需求说明（必备）

### 3.1 功能需求 (Functional Requirements / F-Reqs)

**F1. 核心问答 / 铸星体验 (Casting a Star)**

| ID       | 功能描述                                                                                               | 核心依据 |
| :------- | :----------------------------------------------------------------------------------------------------- | :------- |
| **F1.1** | **自由提问：** 用户可随时在输入栏输入困惑或感受，直接与 AI 开启深度对话。                              |
| **F1.2** | **多轮对话：** AI 具备多轮深入对话的能力，引导用户深化觉察。                                           |
| **F1.3** | **AI 引导（可选）：** 首页提供“每日之问”或“情景触发”的主动对话邀请，作为可选辅助功能。                 |
| **F1.4** | **新卡生成：** 对话结束或收起时，后端（Edge Function）直接根据核心内容生成**新星**，无需草稿确认步骤。 |
| **F1.5** | **系统定级：** 系统仅决策“星卡等级”（影响星球样式/分辨率），**不需要用户手动评级**；银河亮度由前端渲染参数决定，与星卡等级无直接映射。 |
| **F1.6** | **标签系统：** 系统根据内容自动为新卡打上关键词标签（默认打标）。用户若有需求，支持后续手动编辑标签。  |

**F2. 摘星模式 / 灵感之源 (Stargazing Mode)**

| ID       | 功能描述                                                                                                                                  | 核心依据 |
| :------- | :---------------------------------------------------------------------------------------------------------------------------------------- | :------- |
| **F2.1** | **低成本内容获取：** 用户可点击星空或摇动手机触发“摘星”。                                                                                 |
| **F2.2** | **公共灵感源：** 摘星内容从预设的 `inspiration_source` 公共库中抽取“灵感卡片”，包含【问题】和【回响】。                                   |
| **F2.3** | **觉察岔路口：** 用户点击**交互输入区**（类似输入框）即可展开对话并生成【新星】；或向**任意方向滑动**卡片，卡片分解为【星尘】，融入背景。 |
| **F2.4** | **时光摘星：** 提供时间轴拖动条，用户可回溯到过去某个时期的星空进行摘星回顾（保留功能）。                                                 |
| **F2.5** | **按主题/情绪摘星：** 摘星前可选择情绪，系统优先从对应标签的星群中抽取卡片（保留功能）。                                                  |

**F3. 星星演化与银河视图 (Evolution & Visualization)**

| ID       | 功能描述                                                                                                                                 | 核心依据 |
| :------- | :--------------------------------------------------------------------------------------------------------------------------------------- | :------- |
| **F3.1** | **星图骨架：** 星空基于**五大悬臂**（对应 Swift 代码中的设定）的统一骨架进行渲染，避免视觉过于稀疏。                                     |
| **F3.2** | **差异化布局：** 星星位置 (`x_coord, y_coord, z_coord`) 由后端螺旋算法计算，并结合用户觉察标签和顺序，产生**偏移噪声**，确保“千人千面”。 |
| **F3.3** | **初始等级锁定：** 星星的演化状态（新星/超新星）和初始“星卡等级”在**单次生成时**即被确定（若无对话则为“星辰”，不生成星卡）。 |
| **F3.4** | **恒星升级（主动触发）：** 演化状态可由系统规则决定；星卡等级按“对话中的觉察轮次”累加至满级，银河亮度不直接随等级变化。 |
| **F3.5** | **超新星：** 认知突破时生成，并在星空留下**永久的“星云”（`has_nebula`）**背景。                                                          |
| **F3.6** | **(已取消)** ~~星座连接~~：不需要自动连接成星座。                                                                                        |

**F4. 收藏册与回顾 (Collection & Review)**

| ID       | 功能描述                                                                                                           | 核心依据 |
| :------- | :----------------------------------------------------------------------------------------------------------------- | :------- |
| **F4.1** | **多重视图：** 收藏册提供**标签分组视图**（按标签聚合）和**类型视图**（按等级/类型展示），**不展示成长轨迹视图**。 |
| **F4.2** | **分享功能：** 提供“星光信使”功能，将星星卡片转化为精美的、匿名的、脱敏的艺术化图片进行分享。                      |
| **F4.3** | **(已取消)** ~~数据洞察~~：不需要提供数据统计报告。                                                                |

### 3.2 非功能需求 (Non-functional Requirements / NF-Reqs)

| 维度                            | 要求描述                                                                                                                                                                      | 核心依据 |
| :------------------------------ | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :------- |
| **NF1. 性能 (Performance)**     | **低延迟：** 聊天和铸星流程必须基于 Edge Functions 的**全球分布式低延迟**特性。**高性能渲染：** Swift 客户端必须使用 **Metal** 技术栈进行 3D 星空渲染。                       |
| **NF2. 安全性 (Security)**      | **数据隔离：** 必须为所有数据库表（`profiles`, `chats`, `messages`, `stars`）启用 **Row Level Security (RLS)**。**密钥管理：** API 密钥仅存储在 Supabase Project Secrets 中。 |
| **NF3. 可靠性 (Reliability)**   | **数据持久性：** Supabase Postgres 作为主真相源。**多设备同步：** 支持 Swift 客户端在多设备间实时同步。                                                                       |
| **NF4. 可用性 (Usability)**     | **微反馈：** 在铸星、摘星等关键操作时，提供**精细化震动反馈**和音效。**流式响应：** AI 回复必须采用流式响应。                                                                 |
| **NF5. 兼容性 (Compatibility)** | 客户端需确保 Swift/iOS 平台的兼容性和性能稳定。                                                                                                                               |

### 3.3 约束条件与依赖 (Constraints / Dependencies)

| 类别               | 约束/依赖描述                                                                    | 核心依据 |
| :----------------- | :------------------------------------------------------------------------------- | :------- |
| **C1. 技术依赖**   | **后端：** Supabase (PostgreSQL, RLS) + Edge Functions。**前端：** Swift/Metal。 |
| **C2. 架构移植**   | **NextChat 逻辑：** 智能记忆管理逻辑需移植至 Edge Functions。                    |
| **C3. 实现复杂度** | **3D 渲染：** 五大悬臂的螺旋算法及动态光影效果存在较高技术难度。                 |
| **C4. 时间/资源**  | **MVP 阶段**聚焦核心闭环，高级功能作为迭代目标。                                 |
| **C5. 数据设计**   | 需支持 `memory_prompt` 和 `config` JSONB 字段。                                  |

---

## 4. 用户体验 / 交互 / 原型（产品类必备）

### 4.1 关键用户流程 (Key User Flow)

#### 流程一：摘星（灵感驱动）到铸星

1. **触发：** 用户点击星空或摇动手机启动“摘星模式”。
2. **灵感降临：** 动画表现为**最后被点击的星星闪烁**，随后浮现来自“灵感之源”的**灵感卡片**。
3. **决策点：**
    *   **选择 A (深入觉察)：** 用户点击卡片上的**可输入交互区域**（类似输入框） → 界面展开，辅创开启，AI 以该卡片为引子开启对话 → 对话结束/收起对话 → 生成一颗【新星】。
    *   **选择 B (随风而逝)：** 用户向任意方向（上/下/左/右）滑动卡片 → 卡片分解成【星尘】→ 融入星空背景 → 流程结束。

#### 流程二：自由提问（主动探索）到铸星

1. **提问：** 用户在输入栏输入困惑（F1.1）→ AI 接收。
2. **上下文构建：** 后端 Edge Function 运行智能记忆逻辑。
3. **对话：** AI 进行多轮深入对话（F1.2）→ 流式返回回复。
4. **成星：** 收起对话或一段时间无操作 → 后端自动总结、提取标签、**系统计算等级** → 触发“文字转星”动画 → 星星被分配到“五大悬臂”中（F3.1）。
5. **微反馈：** 客户端播放“铸星”音效和精细化震动。

#### 流程三：星空漫游与回顾

1. **漫游限制：** 通过捏合/拖动进行自由缩放和漫游的功能，**目前暂不实现**（不支持）。
2. **回顾交互：** 目前不支持预览标题。点击星星仅触发**点亮（闪烁）动作**。
3. **主动回顾：** 用户在“摘星模式”中抽取并回顾历史星星，并确认“有帮助”。
4. **恒星升级：** 当 `review_count` 达到阈值系统判断升级 → 星星体积和亮度增大。

### 4.2 关键状态与边界情况 (Edge cases in UX)

| 状态类型                     | 场景描述                     | 交互或系统应对                                                       | 核心依据 |
| :--------------------------- | :--------------------------- | :------------------------------------------------------------------- | :------- |
| **空态 (Empty State)**       | 新用户或星图星星数量极少时。 | 界面为深邃黑夜 + 寥寥几颗指引星。引导用户使用**“摘星模式”**。        |
| **边界态 (Star Overload)**   | 星星数量过多。               | **低质量星星分解为“星尘”**；长期沉寂的星星变暗，保持核心星星可见性。 |
| **异常态 (Dialogue Length)** | 单次对话内容过长。           | 自动截断短期消息，优先保留长期记忆摘要。                             |
| **反馈态 (Supernova)**       | AI 识别到用户重大认知突破。  | AI 提议标记为“超新星爆发”→ 客户端触发独特光效与震动。                |

### 4.3 界面草图或原型 (Wireframe / Prototype)

| 界面名称                 | 核心元素                                                                           | 视觉风格与交互要点                                                               | 核心依据 |
| :----------------------- | :--------------------------------------------------------------------------------- | :------------------------------------------------------------------------------- | :------- |
| **Galaxy View (主视图)** | 1. 3D 星空背景。2. **五大悬臂**结构。3. 星星亮度/大小由前端渲染参数决定（非后端等级）。 | **风格：** “矢量+光影”粒子效果。**交互：** 点击星星点亮；摇动/点击背景触发摘星。 |
| **Chat / Input 视图**    | 1. 全屏对话界面。2. 底部输入栏。3. 实时流式响应。                                  | **风格：** 沉浸式。**动效：** 结束对话后，能量汇聚生成星星射向星图。             |
| **Stargazing 模式**      | 1. 模态卡片。2. 【问题】和【回响】。3. **交互输入框**（点击展开对话）。            | **交互：** 滑动（上下左右）消失；点击输入框展开。**动画：** 星星闪烁后出现卡片。 |
| **Collection / 收藏册**  | **视图：** 标签分组、类型/等级分类。                                               | **展示：** 不展示时间线轨迹，侧重于内容的分类和层级展示。                        |

---

> **Metaphor/Analogy for Clarity:**
>
> “集星问问”的架构就像一个**自动化运行的心灵天文台**。Swift 客户端负责呈现五大悬臂的绚丽星空；而后端系统则是精密的计算核心，它自动分析用户的每一次对话（多轮对话），无需用户手动校准（自动评级、打标），将思想的火花转化为星图上精确的坐标，让用户专注于觉察本身。
