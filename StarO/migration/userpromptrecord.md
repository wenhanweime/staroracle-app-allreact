
# 1（已读 2025-12-19 01:51）
/Users/pot/Documents/staroracle-app_allreact/StarO/migration这个是当前
  迁移过程的记录  /Users/pot/Documents/staroracle-backend/docs/swift-
  migration 这是迁移需要遵循的最重要的文档  /Users/pot/Documents/
  staroracle-backend/docs/contracts 这是后端文档,可以拿来参考对照 这里是
  prd /Users/pot/Documents/staroracle-backend/spec-fundation  参考这些文
  档,评估当前我们的swift改动以连接后端进展到哪个步骤了,然后继续进行

# 2（已读 2025-12-19 02:02）
现在有几个问题，
- [x] 1 swift前端，在浮窗出现之后的某个时机，主页的星谕 菜单 starcollection三个按钮的位置会上移，几乎被灵动岛覆盖了，这需要解决，看看是什么导致了这个位置变化。（已完成 2025-12-19 02:04）
- [x] 2 历史对话并没有主题总结，标题全是新会话，需要打通调用大模型总结的链路（已完成 2025-12-19 02:33）
- [x] 3 菜单panel是一个圆角矩形，而star collection则是上下贯穿的侧拉抽屉，我们需要把菜单panel也改成完全从侧面拉出的上下贯穿的样式（已完成 2025-12-19 02:47）
- [x] 4 左侧菜单panel拉出时候会把浮窗和对话框顶到右侧，但是右侧starcollection的抽屉往左拉出来的时候，则没有将对话框顶到左侧，这是不对的，需要对齐菜单panel，把对话框/浮窗顶到左侧（已完成 2025-12-19 02:53）
- [x] 5 点击galaxy弹出的灵感星卡，现在内容过少，只有一个尼采的，展示格式还有问题，让我们首先引入 答案之书的所有答案，这个在当前目录中有，然后就是多策略一些内容类型，名人名言之类的，或者mbti相关的，统一灌倒灵感库（已完成 2025-12-19 03:05）
- [x] 6 接入apple语音，点击对话框语音的时候，可以吊起apple 键盘的语音功能（已完成 2025-12-19 03:19）
- [x] 7 修改starcollection 中卡片的点击交互，点击应该不是反转，而是放大，放大之后变成跟灵感卡一样的大小，浮在屏幕中央，然后可以点击翻转（已完成 2025-12-19 03:39）
- [x] 8 对话中出现的点击查看星卡，点击之后出现的样式也不应该是现在的详情样式，让我们也改成灵感卡片那样的单卡样式（已完成 2025-12-19 03:39）
- [x] 9 对话气泡支持markdown格式（已完成 2025-12-19 03:39）
- [x] 10 增加长期记忆功能，维护一份user的长期记忆，记录user说过的关键事实，总结user的关键性格特征。（已完成 2025-12-19 11:30）

# 3（已读 2025-12-19 11:50）
- [x] 为什么打开之后我历史点亮的galaxy都不见了（已完成 2025-12-19 11:50）

# 4（已读 2025-12-19 12:30）
- [x] 对话发送后一直 loading / 无重试 / 前后端表现不一致（已完成 2025-12-19 12:30）

# 5（已读 2025-12-19 13:05）
- [x] 长期记忆总结触发时机与增量策略核查（已完成 2025-12-19 13:05）
  - 现状：后端仅在 `chat-send done` 后 best-effort 跑用户长期记忆更新；若长对话期间命中 `MIN_INTERVAL`，用户停止输入后不会再触发，从而造成“历史没被总结/长期记忆不更新”的体感。
  - 修复：后端新增 `POST /functions/v1/user-memory-refresh`，端侧应在用户 idle 5-10 分钟后调用（可 `force=true`），并补充游标字段 `last_message_id/last_chat_id` 便于排障；首次构建改为从“最近消息”开始（见后端仓库变更与契约文档）。

# 6（已读 2025-12-19 13:25）
- [x] 对话结束后（idle 触发）调用 user-memory-refresh（已完成 2025-12-19 13:25）

# 7（已读 2025-12-19 13:35）
- [x] 语音功能崩溃（com.avaudiosession.tccserver / brk #0x1）兜底处理（已完成 2025-12-19 13:35）

# 8（已读 2025-12-19 13:45）
- [x] 语音停止按钮卡死/崩溃（停止时仍触发 brk #0x1）修复（已完成 2025-12-19 13:45）

# 9（已读 2025-12-19 14:00）
- [x] 语音停止后仍无法停下/继续触发 brk #0x1（二次修复：回调防串扰） （已完成 2025-12-19 14:00）

# 10（已读 2025-12-19 16:42）
- [x] 语音输入：点击停止后仍无法停止/仍可能触发 `brk #0x1`，修复 stop/start 的 pending deactivation 竞态（已完成 2025-12-19 16:42）。

# 11（已读 2025-12-19 17:18）
- [x] 语音输入：出现 `libdispatch.dylib _dispatch_assert_queue_fail`（队列断言）崩溃，调整 stop 顺序并确保 stop 时移除 tap（已完成 2025-12-19 17:18）。

# 12（已读 2025-12-20 01:40）
- [x] 语音输入：对照《语音问题诊断》，统一在主线程串行执行 start/stop，并加入 token 防串扰（已完成 2025-12-20 01:40）。

# 13（已读 2025-12-20 02:20）
- [x] 语音输入：仍出现 `_dispatch_assert_queue_fail`，栈指向 `makeNonisolatedSpeechTap`（闭包本身被推断为 `@MainActor`），将 tap 闭包创建挪到非 MainActor 的文件级作用域并验证（已完成 2025-12-20 02:20）。

# 14（已读 2025-12-20 02:30）
- [x] 语音输入：点击麦克风无反应（多数是弹窗静默失败导致用户无反馈）；修复为从主窗口 top VC present 提示，并为 `SFSpeechRecognizer(locale: zh-CN)` 增加 fallback（已完成 2025-12-20 02:30）。

# 15（已读 2025-12-20 02:55）
- [x] 语音输入：麦克风按钮录音态需切换为“停止”按钮；toast 仅保留“请开始说话”，避免“联网”相关文案误导（已完成 2025-12-20 02:55）。

# 16（已读 2025-12-20 13:02）
- [x] 语音输入：按钮状态仍不变化，增强按钮多状态 image/selected，确保录音态必显示停止图标（已完成 2025-12-20 13:02）。

# 17（已读 2025-12-20 13:15）
- [x] 语音输入：文字需要持续累计（避免 partial result 回退导致反复刷新）；同时修复 stop 异步 UI 更新覆盖导致的“录音态图标不亮/不变”（已完成 2025-12-20 13:15）。

# 18（已读 2025-12-20 15:05）
- [x] 语音输入：麦克风按钮录音态图标/高亮不更新（始终是麦克风形状、按钮不亮）（已完成 2025-12-20 15:05）
- [x] 语音输入：转写文本需单调累计，避免重复刷新/覆盖（已完成 2025-12-20 15:05）

# 19（已读 2025-12-20 15:10）
- [x] 规则：之后每次用户输入都必须追加记录到本文件（并按已读/完成标注）（已完成 2025-12-20 15:15）
- [x] Galaxy 启动点亮延迟：确认是否在等待云端 stars/highlights/seed 拉取导致“过一会才亮”（已完成 2025-12-20 15:15）
- [x] 方案：实现本地点亮缓存（seed/permanentIndices/24h 临时高亮），启动先读本地再异步回源刷新（已完成 2025-12-20 15:15）

# 20（已读 2025-12-20 15:25）
- [x] 语音交互：录音态下点击“停止”或“发送”都必须停止麦克风监听，避免发送后转写继续写回输入框（已完成 2025-12-20 15:28）

# 21（已读 2025-12-20 15:35）
- [x] 长期记忆系统未生效：定位原因并修复（端侧触发/接口调用/后端落库/前端注入与展示）（已完成 2025-12-21 00:34）
  - [x] 部署函数：`user-memory-refresh`（已完成 2025-12-20）
  - [x] 端侧补齐：restore 后按 idle 判定补触发；个人中心新增“立即刷新”入口（已完成 2025-12-20）
  - [x] 端侧排障：错误文案补齐 `error` 细节（不再只显示 UM99 unknown）（已完成 2025-12-20）
  - [x] 远端 DB 迁移：补齐 `profiles.long_term_memory_*` 字段（此前缺字段导致 `user-memory-refresh` 500）（已完成 2025-12-21 00:34）
  - [x] 回归验证：`user-memory-refresh` 可更新 profiles 字段；个人主页可展示；chat-send 注入不再报错（已完成 2025-12-21 00:34）

# 22（已读 2025-12-20 23:10）
- [x] 清理仓库中不应入库的 Xcode 用户数据（`xcuserdata/*.xcuserstate`/断点等），避免制造无意义 diff 与冲突（已完成 2025-12-20 23:10）

# 23（已读 2025-12-20 23:30）
- [x] `user-memory-refresh` 请求失败 500 UM99：定位并修复（远端 migration + 回归验证）（已完成 2025-12-21 00:34）

# 24（已读 2025-12-21 00:34）
- [x] 追问：为什么要删除（`rm`）这些文件？（已完成 2025-12-21 00:34）
  - 说明：清理 Xcode 用户态文件（如 `xcuserdata/*.xcuserstate`、断点等）以避免入库和冲突；并已通过 `.gitignore` 防止再次产生无意义 diff。

# 25（已读 2025-12-21 00:34）
- [x] 提示：后端 DB password 应该在 `.env.cli` 或 `.env.remote`（已完成 2025-12-21 00:34）
  - 结论：已确认后端仓库 `.env.cli` 具备远端 DB 连接所需信息；本次失败根因是远端缺字段迁移而非缺密码。
