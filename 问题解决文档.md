# GalaxyStore 发布警告问题解决记录

## 问题现象
SwiftUI 在运行过程中持续输出：

```
Publishing changes from within view updates is not allowed, this will cause undefined behavior.
```

同时控制台出现日志：

```
⚠️ GalaxyStore mutate height -> ...
⚠️ GalaxyStore mutate width  -> ...
```

说明 `GalaxyStore` 的 `@Published` 属性（`width` / `height`）在 SwiftUI 正在刷新视图时被同步修改。

## 根因分析
`GalaxyBackgroundView` 的 `Canvas` 每帧渲染都会调用：

```swift
galaxyStore.setCanvasSize(width: size.width, height: size.height)
```

`GalaxyStore.setCanvasSize` 原实现直接写 `width`、`height`，即在视图更新周期内再次触发 `objectWillChange`。SwiftUI 在 `Canvas` 绘制时尚未完成当前帧的更新，自然报出 “Publishing changes from within view updates…”。其他 ObservableObject 通过日志排查均未在警告时发布，锁定唯一来源为 `GalaxyStore`。

## 解决方案
1. 在 `setCanvasSize` 中增加尺寸变化判断，避免重复写入。
2. 当尺寸确实发生变化时，记录 “schedule setCanvasSize …” 日志，并通过 `DispatchQueue.main.async` 去抖后再写 `width` / `height`（使用 `DispatchWorkItem` 防止同一帧多次写入）。
3. 这样可以把状态更新延迟到下一帧执行，彻底避开 SwiftUI 当前的视图更新周期，警告也就消失。

## 实施效果
- 修改后警告不再出现，`GalaxyStore` 仍可以正确更新画布尺寸。
- 通过统一的 `⚠️ … mutate/publish …` 栈日志，若未来再有类似警告，可立刻对照日志堆栈定位问题调用链，并套用相同的“异步 mutate”方式修复。
