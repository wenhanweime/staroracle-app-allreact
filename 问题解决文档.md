# GalaxyStore 发布警告问题解决记录

## 问题现象
SwiftUI 在运行过程中持续输出：

```
Publishing changes from within view updates is not allowed, this will cause undefined behavior.
```

同时控制台出现日志：

```
⚠️ GalaxyStore mutate height -> ...
⚠️ GalaxyStore mutate width  -> ...
```

说明 `GalaxyStore` 的 `@Published` 属性（`width` / `height`）在 SwiftUI 正在刷新视图时被同步修改。

## 根因分析
`GalaxyBackgroundView` 的 `Canvas` 每帧渲染都会调用：

```swift
galaxyStore.setCanvasSize(width: size.width, height: size.height)
```

`GalaxyStore.setCanvasSize` 原实现直接写 `width`、`height`，即在视图更新周期内再次触发 `objectWillChange`。SwiftUI 在 `Canvas` 绘制时尚未完成当前帧的更新，自然报出 “Publishing changes from within view updates…”。其他 ObservableObject 通过日志排查均未在警告时发布，锁定唯一来源为 `GalaxyStore`。

## 解决方案
1. 在 `setCanvasSize` 中增加尺寸变化判断，避免重复写入。
2. 当尺寸确实发生变化时，记录 “schedule setCanvasSize …” 日志，并通过 `DispatchQueue.main.async` 去抖后再写 `width` / `height`（使用 `DispatchWorkItem` 防止同一帧多次写入）。
3. 这样可以把状态更新延迟到下一帧执行，彻底避开 SwiftUI 当前的视图更新周期，警告也就消失。

## 实施效果
- 修改后警告不再出现，`GalaxyStore` 仍可以正确更新画布尺寸。
- 通过统一的 `⚠️ … mutate/publish …` 栈日志，若未来再有类似警告，可立刻对照日志堆栈定位问题调用链，并套用相同的“异步 mutate”方式修复。

---

# 键盘触发浮窗闪烁问题解决记录

## 问题概述
- 场景：原生 ChatOverlay 处于**展开状态**时，iOS 键盘弹起或收回会导致浮窗瞬间"消失/出现"，肉眼看到闪烁。
- 范围：StarO 原生工程（UIKit 双窗口：InputDrawer + ChatOverlay）。

## 根因分析
- 键盘弹起/收回会触发 SwiftUI 根视图重新 layout，`OverlayAnchorView.layoutSubviews` 每次都会调用 `NativeChatBridge.attach(scene)`。
- `attach(scene)` 内部未做同场景判重，反复对已显示的浮窗窗口执行 `window.windowScene = scene`。UIKit 在重复绑定同一 scene 时会短暂将 UIWindow 从层级移除再插入，导致已展开的浮窗瞬间不可见，形成闪烁。
- 之前关于 windowLevel/alpha 的调整已排除，最终确认重复 rebind 才是闪烁触发点。

## 解决方案
- 为 ChatOverlay 和桥接层的 attach 增加 **同场景判重**，避免在同一 `UIWindowScene` 上重复 rebind：
  - 当 `overlayWindow.windowScene === scene` 时直接 return，不再执行 `window.windowScene = scene`。
  - 桥接层同样在已绑定且背景视图有效时跳过重复配置，避免再次触发窗口重绑。

## 关键改动
- 文件：`StarO/StarO/ChatOverlayManager.swift`
  - `attach(to:)` 增加判重：已在同一 scene 时不再重新设置 `window.windowScene`，避免窗口被移出/再插回导致闪烁。
- 文件：`StarO/StarO/NativeChatBridge.swift`
  - `attach(to:)` 增加判重：同场景且已有有效背景视图时跳过重复 attach 与背景配置，减少窗口重绑触发。

## 验证结果
- 手工测试：键盘弹起/收回时，展开态浮窗保持稳定，无再现闪烁。
