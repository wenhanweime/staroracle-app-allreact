import Foundation
import Capacitor
import SwiftUI
import UIKit

@objc(ChatOverlayPlugin)
public class ChatOverlayPlugin: CAPPlugin {
    
    private var overlayHostingController: UIHostingController<NativeChatOverlay>?
    private var isOverlayVisible = false
    private var isOverlayExpanded = false
    
    public override func load() {
        NSLog("ğŸš€ ChatOverlayPlugin å·²åŠ è½½!")
    }
    
    @objc func show(_ call: CAPPluginCall) {
        NSLog("ğŸ“± ChatOverlayPlugin: showæ–¹æ³•è¢«è°ƒç”¨")
        call.resolve(["status": "success", "message": "ChatOverlayæ’ä»¶æ­£å¸¸å·¥ä½œ"])
    }
    
    @objc func hide(_ call: CAPPluginCall) {
        NSLog("ğŸ“± ChatOverlayPlugin: hideæ–¹æ³•è¢«è°ƒç”¨")
        DispatchQueue.main.async {
            self.hideNativeOverlay()
            call.resolve()
        }
    }
    
    @objc func sendMessage(_ call: CAPPluginCall) {
        NSLog("ğŸ“± ChatOverlayPlugin: sendMessageæ–¹æ³•è¢«è°ƒç”¨")
        let message = call.getString("message") ?? ""
        
        // æ¨¡æ‹ŸAIå“åº”
        DispatchQueue.main.asyncAfter(deadline: .now() + 1.0) {
            self.notifyListeners("messageReceived", data: [
                "response": "è¿™æ˜¯å¯¹'\(message)'çš„AIå“åº”",
                "timestamp": Date().timeIntervalSince1970
            ])
        }
        
        call.resolve()
    }
    
    private func showNativeOverlay(isExpanded: Bool) {
        NSLog("ğŸ“± showNativeOverlayå¼€å§‹æ‰§è¡Œï¼ŒisExpanded: \(isExpanded)")
        
        if overlayHostingController != nil {
            NSLog("ğŸ“± æµ®çª—å·²å­˜åœ¨ï¼Œç›´æ¥æ›´æ–°çŠ¶æ€")
            isOverlayExpanded = isExpanded
            return
        }
        
        isOverlayExpanded = isExpanded
        
        let overlayView = NativeChatOverlay(
            isExpanded: .constant(isExpanded),
            onClose: { [weak self] in
                NSLog("ğŸ“± æµ®çª—å…³é—­å›è°ƒè¢«è°ƒç”¨")
                self?.hideNativeOverlay()
                self?.notifyListeners("overlayStateChanged", data: ["isOpen": false])
            },
            onReopen: { [weak self] in
                NSLog("ğŸ“± é‡æ–°æ‰“å¼€æµ®çª—å›è°ƒè¢«è°ƒç”¨")
                self?.isOverlayExpanded = true
                self?.notifyListeners("overlayStateChanged", data: ["isOpen": true])
            },
            onFollowUpProcessed: { [weak self] in
                NSLog("ğŸ“± åç»­é—®é¢˜å¤„ç†å®Œæˆå›è°ƒè¢«è°ƒç”¨")
                self?.notifyListeners("followUpProcessed", data: [:])
            }
        )
        
        let hostingController = UIHostingController(rootView: overlayView)
        hostingController.view.backgroundColor = UIColor.clear
        hostingController.modalPresentationStyle = .overFullScreen
        hostingController.modalTransitionStyle = .crossDissolve
        
        overlayHostingController = hostingController
        
        if let viewController = bridge?.viewController {
            NSLog("ğŸ“± å¼€å§‹presentæµ®çª—")
            viewController.present(hostingController, animated: true) { [weak self] in
                NSLog("ğŸ“± æµ®çª—presentå®Œæˆ")
                self?.isOverlayVisible = true
                self?.notifyListeners("overlayStateChanged", data: ["isOpen": true])
            }
        } else {
            NSLog("âŒ viewControllerä¸ºnil")
        }
    }
    
    private func hideNativeOverlay() {
        guard let hostingController = overlayHostingController else { return }
        
        hostingController.dismiss(animated: true) { [weak self] in
            self?.overlayHostingController = nil
            self?.isOverlayVisible = false
            self?.notifyListeners("overlayStateChanged", data: ["isOpen": false])
        }
    }
    
    // æ¥æ”¶æ¥è‡ªJavaScriptçš„AIå›å¤
    @objc func receiveAIResponse(_ call: CAPPluginCall) {
        let response = call.getString("response") ?? ""
        let timestamp = call.getDouble("timestamp") ?? Date().timeIntervalSince1970
        
        NSLog("ğŸ“± receiveAIResponse: \(response)")
        
        // è¿™é‡Œå¯ä»¥å°†AIå›å¤ä¼ é€’ç»™SwiftUIç•Œé¢
        // æš‚æ—¶é€šè¿‡å›è°ƒé€šçŸ¥ç•Œé¢æ›´æ–°
        self.notifyListeners("aiResponse", data: [
            "response": response,
            "timestamp": timestamp
        ])
        
        call.resolve()
    }
    
    // ä»JavaScriptç«¯æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
    @objc func updateMessages(_ call: CAPPluginCall) {
        let messagesArray = call.getArray("messages", JSObject.self) ?? []
        NSLog("ğŸ“± updateMessages: æ¥æ”¶åˆ°\(messagesArray.count)æ¡æ¶ˆæ¯")
        
        DispatchQueue.main.async {
            self.updateOverlayMessages(messagesArray)
        }
        
        call.resolve()
    }
    
    // è®¾ç½®å¯¹è¯æ ‡é¢˜ - å¯¹åº”Webç‰ˆæœ¬çš„conversationTitleåŠŸèƒ½
    @objc func setConversationTitle(_ call: CAPPluginCall) {
        let title = call.getString("title") ?? ""
        NSLog("ğŸ“± setConversationTitle: \(title)")
        
        DispatchQueue.main.async {
            self.updateOverlayConversationTitle(title)
        }
        
        call.resolve()
    }
    
    // è®¾ç½®é”®ç›˜é«˜åº¦ - å¯¹åº”Webç‰ˆæœ¬çš„é”®ç›˜é€‚é…åŠŸèƒ½
    @objc func setKeyboardHeight(_ call: CAPPluginCall) {
        let height = call.getFloat("height") ?? 0.0
        NSLog("ğŸ“± setKeyboardHeight: \(height)")
        
        DispatchQueue.main.async {
            self.updateOverlayKeyboardHeight(CGFloat(height))
        }
        
        call.resolve()
    }
    
    // è®¾ç½®è§†å£é«˜åº¦ - å¯¹åº”Webç‰ˆæœ¬çš„è§†å£é€‚é…
    @objc func setViewportHeight(_ call: CAPPluginCall) {
        let height = call.getFloat("height") ?? 0.0
        NSLog("ğŸ“± setViewportHeight: \(height)")
        
        DispatchQueue.main.async {
            self.updateOverlayViewportHeight(CGFloat(height))
        }
        
        call.resolve()
    }
    
    // è®¾ç½®åˆå§‹è¾“å…¥ - å¯¹åº”Webç‰ˆæœ¬çš„initialInputåŠŸèƒ½
    @objc func setInitialInput(_ call: CAPPluginCall) {
        let input = call.getString("input") ?? ""
        NSLog("ğŸ“± setInitialInput: \(input)")
        
        DispatchQueue.main.async {
            self.updateOverlayInitialInput(input)
        }
        
        call.resolve()
    }
    
    // è®¾ç½®åç»­é—®é¢˜ - å¯¹åº”Webç‰ˆæœ¬çš„followUpQuestionåŠŸèƒ½
    @objc func setFollowUpQuestion(_ call: CAPPluginCall) {
        let question = call.getString("question") ?? ""
        NSLog("ğŸ“± setFollowUpQuestion: \(question)")
        
        DispatchQueue.main.async {
            self.updateOverlayFollowUpQuestion(question)
        }
        
        call.resolve()
    }
    
    // æ›´æ–°SwiftUIç•Œé¢çš„æ¶ˆæ¯åˆ—è¡¨
    private func updateOverlayMessages(_ messages: [JSObject]) {
        guard let hostingController = overlayHostingController else { return }
        
        NSLog("ğŸ“± æ›´æ–°ç•Œé¢æ¶ˆæ¯åˆ—è¡¨")
        
        // é€šè¿‡äº‹ä»¶é€šçŸ¥çš„æ–¹å¼æ›´æ–°SwiftUIçŠ¶æ€
        self.notifyListeners("messagesUpdated", data: [
            "messages": messages,
            "count": messages.count
        ])
    }
    
    // æ›´æ–°SwiftUIç•Œé¢çš„å¯¹è¯æ ‡é¢˜
    private func updateOverlayConversationTitle(_ title: String) {
        self.notifyListeners("conversationTitleChanged", data: [
            "title": title
        ])
    }
    
    // æ›´æ–°SwiftUIç•Œé¢çš„é”®ç›˜é«˜åº¦
    private func updateOverlayKeyboardHeight(_ height: CGFloat) {
        self.notifyListeners("keyboardHeightChanged", data: [
            "height": height
        ])
    }
    
    // æ›´æ–°SwiftUIç•Œé¢çš„è§†å£é«˜åº¦
    private func updateOverlayViewportHeight(_ height: CGFloat) {
        self.notifyListeners("viewportHeightChanged", data: [
            "height": height
        ])
    }
    
    // æ›´æ–°SwiftUIç•Œé¢çš„åˆå§‹è¾“å…¥
    private func updateOverlayInitialInput(_ input: String) {
        self.notifyListeners("initialInputChanged", data: [
            "input": input
        ])
    }
    
    // æ›´æ–°SwiftUIç•Œé¢çš„åç»­é—®é¢˜
    private func updateOverlayFollowUpQuestion(_ question: String) {
        self.notifyListeners("followUpQuestionChanged", data: [
            "question": question
        ])
    }
    
    // è®¾ç½®åŠ è½½çŠ¶æ€
    @objc func setLoading(_ call: CAPPluginCall) {
        let loading = call.getBool("loading") ?? false
        NSLog("ğŸ“± setLoading: \(loading)")
        
        DispatchQueue.main.async {
            self.setOverlayLoading(loading)
        }
        
        call.resolve()
    }
    
    // è®¾ç½®SwiftUIç•Œé¢çš„åŠ è½½çŠ¶æ€
    private func setOverlayLoading(_ loading: Bool) {
        guard let hostingController = overlayHostingController else { return }
        
        NSLog("ğŸ“± è®¾ç½®ç•Œé¢åŠ è½½çŠ¶æ€: \(loading)")
        
        self.notifyListeners("loadingStateChanged", data: [
            "loading": loading
        ])
    }
}

// æµ®çª—çŠ¶æ€ç®¡ç†ç±» - ç”¨äºåœ¨Swiftå’ŒJavaScriptä¹‹é—´åŒæ­¥çŠ¶æ€
class OverlayState: ObservableObject {
    @Published var messages: [ChatMessage] = []
    @Published var isLoading = false
    @Published var conversationTitle = ""
    @Published var keyboardHeight: CGFloat = 0
    @Published var viewportHeight: CGFloat = UIScreen.main.bounds.height
    @Published var initialInput = ""
    @Published var followUpQuestion = ""
    @Published var isKeyboardOpen = false
}