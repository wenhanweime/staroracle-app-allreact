# StarOracle iOS 对话浮窗与会话历史改造方案（评审版）

本文档面向产品/工程/客户端三方评审，汇总现状诊断、问题根因、总体方案、实现规划、风险与验证策略，
作为实施参考。

## 1. 背景与目标

- 背景：App 的 AI 对话以“浮窗 + 原生输入框”形式进行，现存在首轮交互体验不一致、关闭后再次发送未创
建新会话等问题；同时希望引入“历史对话列表（会话管理）”能力，显示在左侧菜单。
- 目标：
    - 修复“首次收缩不一致”“启动时点输入框迟滞”的体验问题。
    - 规范“关闭后首次输入即新会话”的行为，且会话可持久化，供左侧菜单浏览与切换。
    - 在不破坏现有稳定路径前提下，以“最小侵入”方案推进，优先 iOS 原生通路，Web 保持兼容。

## 2. 现状与问题

- 启动后点击输入框响应慢：
    - 原因：SplashScreen 延迟隐藏（500ms + 300ms 渐隐），遮挡顶层触摸，导致首次点击迟滞。
- 首次收缩（展开→收缩）与之后不一致：
    - 表征：首次收缩时浮窗高度、与底部距离、输入框“弹起”不一致；第二次及之后正常。
    - 原因（iOS 原生路径）：双窗口（ChatOverlay/InputDrawer）初始化与键盘状态的竞态。首次收缩时，
InputDrawer 处于“键盘可见”的早退分支，不会为浮窗预留 40px 空间；同时浮窗按“应预留”的假设进位，造
成首次错位。
- 关闭浮窗后再次发送未创建新会话：
    - 现状：原生 ChatOverlayManager 只有内存 messages，未打通 ConversationStore；关闭行为未落盘，
重新发送未新建会话，导致“看不到新浮窗/新会话”的表象。
- 历史对话缺失：
    - 未暴露原生会话存储（ConversationStore）的插件 API 至前端；左侧菜单无数据源。

## 3. 原因分析（iOS 重点）

- 双窗口竞态：
    - 收缩时，InputDrawer.updateBottomSpace 在“键盘可见”分支下早退，不进行 bottomSpace = 40 的动
画预留；浮窗则假设有预留，导致首次对不齐。
    - 首次时序还受 safeArea 首帧、监听器挂载先后、背景 3D 动画等因素影响。
- 单一真源缺失：
    - 原生消息与会话未接入 ConversationStore，关闭后“结束当前会话/新建会话”的语义缺失，导致再发未
新开，且历史缺失。
- JS/原生双源：
    - JS 有一套 useChatStore.messages；原生同时维护 messages。若 JS 把整段历史回传原生，会与原生
会话语义冲突。

## 4. 设计原则

- “只改第一次”：针对首次收缩的错位与输入框“未弹起”问题，仅在“首轮”做一次性对齐/预留，不更改后续逻
辑与参数。
- 单一真源：iOS 原生 ConversationStore 作为会话数据唯一真源；所有流式增量回调都同步写入
ConversationStore。
- 最小侵入：优先改 iOS 原生端，不拆大结构；Web 菜单保持 React 渲染，仅换数据来源为原生插件 API。
- 可回退：每步变更小粒度提交，便于快速回退。

## 5. 总体方案

- 体验修复（已实施/将实施）：
    - 启动迟滞：SplashScreen.hide({fadeOutDuration:120}) 立即隐藏，释放首交互。（已改）
    - 首次收缩错位：
    - InputDrawer：键盘可见的早退分支也广播“实际 bottomSpace”；且在“首次收缩+键盘可见”时，额外在
键盘之上为浮窗预留 40px（仅一次）并动画。（已改）
    - ChatOverlay：首次收缩时等待一次实际位置广播来对齐，150ms 兜底。（已改）
- 关闭→新会话：
    - 在 hide() 将当前 messages 落盘到 ConversationStore 并置位 startNewOnNextInput=true；
    - 在 startNativeStreaming() 首条发送前检查置位：创建新会话，切换 currentSessionId，清空渲染层
messages，再开始本轮流式。
- 历史会话：
    - ChatOverlay 流式 appendAIChunk/updateLastAI 同步写入 ConversationStore（insert/replace），
保持渲染层与持久层一致。
    - 插件新增 API：listSessions、switchSession、newSession(title?)、renameSession、
deleteSession、以及事件 sessionsChanged。
    - 前端左侧菜单仍用 React，绑定上述 API 数据；点击项 -> switchSession + loadHistory(sessionId)
刷新浮窗消息。

## 6. 架构与模块改动

- iOS 原生（主要）
    - ios/App/App/ChatOverlayManager.swift
    - 新增：`startNewOnNextInput` 标记；`hide()` 落盘并置位；`startNativeStreaming()` 首次检查置
位 -> `ConversationStore.createSession + switchSession` + 清空渲染层。
    - 首次收缩等待对齐（已加 `awaitingFirstCollapseAlign/didFirstCollapseAlign` 标记与 150ms
兜底）。
    - Streaming 回调写入 `ConversationStore.append/replaceLastAssistantText`。
- ios/App/App/ConversationStore.swift
    - 已有：会话持久化（sessions + currentSessionId）。补充：必要校验/迁移/标题生成入口。
- ios/App/App/ChatOverlayPlugin.swift
    - 新增方法：`listSessions/switchSession/newSession/renameSession/deleteSession`、事件
`sessionsChanged`。
- JS/前端（最小变更）
    - src/App.tsx
    - 原生路径：handleSendMessage 通过 plugin 启动原生流式；不再回传整段 JS 历史，仅传本次用户输
入（由原生拼装上下文）。
    - SplashScreen 立即隐藏（已改）。
- 左侧菜单组件
    - 读取 `listSessions` 渲染列表；点击项调用 `switchSession` 并 `loadHistory(sessionId)` 更新浮
窗内容。

## 7. 分阶段执行计划

- 阶段 0：首交互与首收缩稳定（已完成/进行中）
    - [x] 立即隐藏 SplashScreen（已提交 4b9bb00）
    - [x] 首次收缩对齐：InputDrawer 键盘可见时广播位置 + ChatOverlay 首次等待对齐 + 150ms 兜底
（已提交 1ed95eb、d895a13）
- 阶段 1：关闭→新会话（原生）
    - [ ] ChatOverlayManager.hide(): 取消流式、落盘当前会话、置位 startNewOnNextInput
    - [ ] startNativeStreaming(): 首条发送前检查置位，新建会话并清空渲染层
    - [ ] Streaming 回调写入 ConversationStore
    - 验收：关闭后首次发送必定新会话；历史会话文件可见。
- 阶段 2：历史会话 API（原生插件）
    - [ ] listSessions/switchSession/newSession/renameSession/deleteSession + sessionsChanged
事件
    - 验收：JS 可列表、切换、重命名与删除会话。
- 阶段 3：左侧菜单绑定（前端）
    - [ ] 菜单渲染会话列表，点击切换加载历史
    - [ ] 当前会话高亮、更新时间排序、最近摘要（可选）
    - 验收：UX 与稳定性通过“多轮切换、关闭后新建、重启恢复”冒烟。
- 阶段 4：标题与摘要（可选增强）
    - [ ] 会话标题延迟生成（首条 AI 完成后）
    - [ ] 最近摘要缓存到 store
    - 验收：列表展示更友好。

## 8. 风险与缓解

- 风险：首轮对齐仍偶发
    - 缓解：InputDrawer 增加广播、ChatOverlay 首次等待 + 兜底，必要时延时从 150ms 调到 120–200ms
并加日志追踪。
    - 缓解：菜单保留 React 渲染；一次仅加载当前会话消息体，列表仅取基本字段（title、updatedAt、
snippet）。

## 9. 测试与验收

- 用例（iOS 原生）：
    - 启动即点输入框：立即响应，键盘弹起。
    - 展开→收缩（键盘未弹出）：第一次与第二次位置一致（相同高度/距离）。
    - 展开→收缩（键盘已弹出）：第一次与第二次位置一致，输入框“弹起”预留到位。
    - 关闭后再发：新会话创建、浮窗出现、历史增加。
    - 多会话切换：菜单点击不同会话，浮窗加载对应消息；重启后仍能恢复列表。
- 日志观察：
    - InputDrawer: “键盘可见… 已广播实际位置” 日志
    - ChatOverlay: “首次收缩对齐完成/兜底定位” 日志
    - 会话：create/switch/append/replaceLastAssistantText 成功日志
- 手工 QA：连续触发“关闭→新会话→切换→重命名→删除”

## 10. 回滚方案

- 启动延迟回滚：恢复 SplashScreen 延时隐藏。
- 首次收缩回滚：移除首次等待对齐/键盘预留逻辑，回到旧路径（无对齐补偿）。
- 会话管理回滚：禁用插件会话 API，在 JS 菜单隐藏“历史对话”入口。

## 11. 时间与工作量（粗略）

- 阶段 0：0.5–1 天（已完成）
- 阶段 1：1–1.5 天（新会话生命周期 + 落盘）
- 阶段 2：1–1.5 天（插件 API + 事件）
- 阶段 3：1 天（菜单绑定）
- 阶段 4：0.5–1 天（标题/摘要）
- QA 与调整：1–2 天

## 12. 未决项 / 需要确认

- “关闭后首次发送”是否固定新会话？（建议：是）
- 会话标题生成策略：是用首条 AI 回复生成、还是用首条用户问题截取？（建议：AI 回复完成后生成，失败
时用首条 user 截断）
- 左侧菜单排序：按 updatedAt 倒序，是否支持手动置顶？（可选）
- Android 是否一并实现？（当前方案先 iOS）

## 13. 参考代码路径（关键）

- iOS
    - ChatOverlay 窗口与状态：ios/App/App/ChatOverlayManager.swift
    - 输入框窗口：ios/App/App/InputDrawerManager.swift
    - 会话存储：ios/App/App/ConversationStore.swift
    - Capacitor 插件：ios/App/App/ChatOverlayPlugin.swift
- JS/前端
    - 应用入口：src/App.tsx（原生初始化、Splash、InputDrawer 监听）
    - 浮窗（Web 回退）：src/components/ChatOverlay.tsx
    - 会话桥接：src/utils/conversationBridge.ts

附：已实施的“仅首次”修复清单（iOS 原生）

- 启动响应：SplashScreen.hide 改为立即隐藏（提交 4b9bb00）
- 首次收缩对齐（提交 1ed95eb、d895a13）：
    - 输入框：键盘可见早退时也广播实际位置；首次收缩时若键盘可见，额外为浮窗预留 40px（仅一次）
    - 浮窗：首次等待实际位置广播后对齐；150ms 兜底
- 其后收缩/展开逻辑与参数未改动，保证只影响第一次

如确认本方案，我将先落地“关闭→新会话（Phase 1）”，随后补“历史 API 与菜单（Phase 2/3）”。

## 本次修改日志（实现对话架构升级要点）

- iOS 原生：ChatOverlayManager.swift
  - 新增 `startNewOnNextInput` 标记；`hide()` 时将当前 `messages` 落盘到 `ConversationStore`，并置位该标记为 true。
  - 在 `startNativeStreaming(...)` 首次发送前检查标记：创建新会话（`ConversationStore.createSession("新会话")`）、清空渲染层并刷新，再开始本轮流式。
  - 将流式回调增量写入持久层：`appendAIChunk`/`updateLastAI` 分别调用 `ConversationStore.append/replaceLastAssistantText` 保持与 UI 同步。
  - `setSystemPrompt` 同步写入 `ConversationStore`；`loadHistory()` 改为从 `ConversationStore` 读取为唯一真源。

- iOS 原生：ConversationStore.swift
  - 补充会话管理 API：`renameSession(id,title)`、`deleteSession(id)`；删除当前会话时自动选择合适的 current 会话或创建默认会话。

- iOS 原生：ChatOverlayPlugin.swift
  - 增加会话管理插件方法：`listSessions`、`switchSession`、`newSession`、`renameSession`、`deleteSession`。
  - 新增事件 `sessionsChanged`：对上述会话操作后向前端广播最新会话列表（含 `id/title/createdAt/updatedAt`）。
  - 现有 `loadHistory` 复用 `overlayManager.loadHistory()`，以 `ConversationStore` 为真源刷新浮窗。

## 本次修改日志（侧边历史会话交互修复）

- 前端：src/components/DrawerMenu.tsx
  - 移除历史会话项上的“重命名/删除”悬浮按钮，避免点击后出现二次操作入口。
  - 调整交互为“单击整行即切换会话 + 唤起对话浮窗”，调用顺序：`switchSession(id)` -> `ChatOverlay.show({ isOpen: true })` -> `onClose()`。
  - 精简不再使用的桥接导入与处理函数：删除 `renameSession/deleteSession` 相关导入与逻辑。

### 编译修复
- iOS 原生：`ios/App/App/ChatOverlayManager.swift`
  - 移除一行误植的中文说明文本（位于属性声明区，约第79行），该行未被注释导致 Swift 语法错误（Expected '{' in body of function declaration 等）。
  - 现已删除该行并标注注释，恢复文件可编译状态。

## 本次修改日志（历史会话名称自动总结）

- iOS 原生：`ios/App/App/ChatOverlayPlugin.swift`
  - 为侧边栏的历史会话列表增加“展示用标题”的自动总结逻辑（仅影响前端展示，不直接改写持久化标题）。
  - 规则：
    - 会话消息数 ≤ 4：标题统一显示为“闲聊对话”。
    - 会话消息数 > 4：基于前几条消息文本生成简洁标题（去除换行/表情/冗余标点，最多取前10个可见字符，去尾标点）。
    - 若存在用户自定义的非默认标题（非空、且不为“新会话/默认会话/迁移会话/未命名会话”），则优先使用用户标题。
  - 应用范围：
    - `listSessions` 返回的会话列表中，`title` 字段即为上述“展示用标题”。
    - `sessionsChanged` 事件推送同样应用该展示标题，保证左侧菜单实时一致。

- JS 前端：基于“弹幕型链路”的AI标题总结（持久化为会话标题）
  - `ios/App/App/ChatOverlayPlugin.swift`
    - 新增 `getSessionSummaryContext(id,limit)`，返回指定会话的前N条消息和总消息数，用于前端构造提示词。
    - `listSessions` 与 `sessionsChanged` 额外返回 `messagesCount`、`rawTitle`、`displayTitle`、`hasCustomTitle`，其中 `displayTitle` 供展示兜底，`hasCustomTitle` 用于精准判断是否需要AI总结。
    - 监听 `conversationStoreChanged`，在会话消息/标题持久化变化时实时 `emitSessionsChanged()`，确保对话结束后能触发前端的总结流程。
  - `src/plugins/ChatOverlay.ts`/`src/utils/conversationBridge.ts`
    - 补充 `getSessionSummaryContext` 类型与桥接导出；`listSessions` 类型包含 `messagesCount/rawTitle/displayTitle/hasCustomTitle`。
  - `src/components/DrawerMenu.tsx`
    - 加载/订阅会话列表后，对满足条件（消息数>4且 `hasCustomTitle=false` 的会话）触发AI总结流程：
      1) 调用 `getSessionSummaryContext` 获取上下文片段
      2) 调用 `generateAIResponse`（以 onStream 方式走弹幕型链路）按统一提示词生成≤10字中文标题
      3) 清洗结果（去标点、裁剪10字）后调用 `renameSession` 持久化标题
    - 取消条数阈值：所有有消息的会话（`count>0` 且 `hasCustomTitle=false`）均触发 AI 总结；不再使用“闲聊对话”作为固定标题。
  - 展示兜底：在 AI 总结落盘前，原生 `displayTitle(for:)` 以前几条文本裁剪的方式提供过渡标题；若文本为空则显示“未命名会话”。

- 前端桥接：src/utils/conversationBridge.ts
  - 新增桥接函数：`listSessions/switchSession/newSession/renameSession/deleteSession` 与 `onSessionsChanged` 事件订阅。

- 前端插件类型：src/plugins/ChatOverlay.ts 与 Web Stub：src/plugins/ChatOverlayWeb.ts
  - 扩展 TypeScript 接口，补全上述会话管理方法，Web 端提供安全的 stub 输出日志便于调试。

说明：本次改动聚焦对话会话的“单一真源 + 生命周期”与“会话列表 API”落地，配合此前已完成的“首次收缩对齐/键盘预留”方案，实现文档 5/6 章的核心改动点。

补充：左侧彩蛋栏集成

- DrawerMenu：src/components/DrawerMenu.tsx
  - 新增“历史对话”分区，展示会话列表（按 updatedAt 倒序）。
  - 支持“新建会话/重命名/删除/切换”操作；通过 conversationBridge 调用原生插件，监听 sessionsChanged 自动刷新。
  - 切换会话后自动关闭抽屉，原生浮窗通过 `switchSession -> loadHistory` 即时加载对应消息。

## 本次修改日志（侧边栏滚动优化）

- 前端：`src/components/DrawerMenu.tsx`
  - 抽屉容器设为 `flex flex-col`，使中间内容区可按剩余高度伸缩。
  - 中间列表区域设置为 `flex-1 overflow-y-auto`，并开启 `-webkit-overflow-scrolling: touch`，在 iOS 上获得顺滑滚动。
  - 顶部标题区和底部用户信息区保持固定高度，内容较多时可在中间区域上下滚动。

## 本次修改日志（侧边栏布局调整）

- 前端：`src/components/DrawerMenu.tsx`
  - 移除“新建会话”按钮（列表上方区域）。
  - 顶部标题替换为搜索框（支持按标题关键字过滤历史会话）。
  - 顶部右侧“X”关闭按钮改为“铅笔”编辑图标；点击该图标执行新建对话逻辑。
