# 📂 staroracle-app_v1 功能-代码映射报告 (精细版)

## 🏗️ 项目概览
- **技术栈**: React, TypeScript, Capacitor, Zustand, Framer Motion, Tailwind CSS
- **架构模式**: 基于组件 (Component-based) 的架构。
- **状态管理**: Zustand (`useStarStore.ts`) 用于全局状态管理，集中处理星座数据、UI状态和核心业务逻辑。
- **样式方案**: Tailwind CSS 用于功能类样式，结合 `index.css` 中的全局样式和自定义组件样式。

## 🗂️ 目录结构概览
项目遵循典型的React应用结构，将所有源代码放在 `src` 目录下。
- `src/components`: 包含所有可重用的UI组件。
- `src/store`: 包含Zustand状态管理逻辑。
- `src/types`: 存放TypeScript类型定义。
- `src/utils`: 包含各种辅助函数，如AI交互、声音、模板管理等。
- `src/App.tsx`: 应用主入口组件，负责组装所有主要UI部分。
- `src/main.tsx`: 应用渲染的起点。

---

## 🎯 功能映射表

## 主应用与布局
> **模块描述**: 应用的根组件，负责整体布局、状态初始化以及各大模态框（如设置、收藏、模板选择等）的显隐控制。
> **主组件文件**: `src/App.tsx`

### 1. 动态星空背景
**🔤 用户描述方式**:
- **主要**: "背景里的星星", "会动的星空背景"
- **别名**: "宇宙背景", "动态墙纸"

**📍 代码位置**:
- **组件文件**: `src/components/StarryBackground.tsx` - 整个组件负责此功能。
- **集成**: `src/App.tsx` - `<StarryBackground starCount={150} />`

**🎨 视觉与行为**:
- **外观**: 深邃的宇宙背景，包含缓慢移动、闪烁的星星和流动的星云。
- **行为**: 背景是动态的，星星会缓慢下落并有闪烁效果。鼠标悬停在附近时，星星会变亮，产生轻微的视差和辉光效果。这是一个纯视觉元素，没有点击交互。

**🛠️ 修改指引**:
- **改星星数量/外观**: 修改 `src/App.tsx` 中的 `starCount` 属性，或 `StarryBackground.tsx` 中 `stars` 数组的生成逻辑（如 `size`, `opacity`）。
- **改动画效果**: 调整 `StarryBackground.tsx` 中 `render` 函数的动画逻辑（如 `speed`, `twinkleSpeed`）。
- **改颜色/星云**: 修改 `StarryBackground.tsx` 中 `nebulae` 数组的颜色和半径设置。

### 2. 应用顶部标题
**🔤 用户描述方式**:
- **主要**: "顶部的标题", "应用名字"
- **别名**: "Logo", "Header"

**📍 代码位置**:
- **组件文件**: `src/components/Header.tsx` - 定义了标题的结构和样式。
- **集成**: `src/App.tsx` - `<Header />`

**🎨 视觉与行为**:
- **外观**: 居中显示，包含一个动态的星芒图标和文字 "星谕 (StellOracle)"。
- **文本/占位符**: "星谕 (StellOracle)"
- **行为**: 静态显示，无交互。

**🛠️ 修改指引**:
- **改文本**: 修改 `src/components/Header.tsx` 中的 `<span>` 文本内容。
- **改图标**: 修改 `src/components/Header.tsx` 中 `<StarRayIcon />` 组件的属性。
- **改样式/位置**: 调整 `src/components/Header.tsx` 中的Tailwind类或内联样式。

---

## 星座与核心交互
> **模块描述**: 用户与星座进行交互的核心区域，包括查看、点击、创建星星。
> **主组件文件**: `src/components/Constellation.tsx`

### 1. 星座交互区域
**🔤 用户描述方式**:
- **主要**: "中间的星空", "可以点的地方"
- **别名**: "主画布", "星座图"

**📍 代码位置**:
- **组件文件**: `src/components/Constellation.tsx` - `<div className="constellation-area"...>`
- **状态/逻辑**: `src/store/useStarStore.ts` @ `isAsking`, `isLoading`, `pendingStarPosition`
- **样式**: `src/index.css` - `.constellation-area` 类

**🎨 视觉与行为**:
- **外观**: 占据整个屏幕的主要区域，鼠标悬停时显示一个光圈指示器。
- **行为**:
    - **单击**: 在空白区域单击会激活提问模式，底部输入框会聚焦。由 `handleBackgroundClick` 函数处理，并调用 `setIsAsking(true, { x, y })`。
    - **双击**: 快速双击会触发“摘星”模式，弹出一个“灵感卡片”。由 `handleBackgroundClick` 检测时间差实现。
    - **右键单击**: 触发“灵感卡片”弹出。由 `handleContextMenu` 函数处理。

**🛠️ 修改指引**:
- **改交互逻辑**: 修改 `src/components/Constellation.tsx` 中的 `handleBackgroundClick` 和 `handleContextMenu` 函数。
- **改悬浮光圈**: 调整 `src/index.css` 中的 `.hover-indicator` 或 `.constellation-area::before` 样式。

### 2. 单个星星
**🔤 用户描述方式**:
- **主要**: "屏幕上的星星", "一个光点"
- **别名**: "恒星", "节点"

**📍 代码位置**:
- **组件文件**: `src/components/Star.tsx` - 定义单个星星的视觉和动画。
- **渲染逻辑**: `src/components/Constellation.tsx` - 在 `stars.map(...)` 中渲染 `<Star />` 组件。
- **状态/逻辑**: `src/store/useStarStore.ts` @ `constellation.stars` - 星星的数据源。

**🎨 视觉与行为**:
- **外观**: 不同大小和亮度的圆形光点，特殊星星或连接数多的星星会更大并有动画效果。被选中的星星会高亮（`isActive`）。
- **行为**: 单击星星会触发 `handleStarClick`，调用 `viewStar(id)`，弹出该星星的详情面板。

**🛠️ 修改指引**:
- **改外观/动画**: 修改 `src/components/Star.tsx` 中的 `motion.div` 样式和动画属性。
- **改点击行为**: 修改 `src/components/Constellation.tsx` 中的 `handleStarClick` 函数。

### 3. 星星之间的连线
**🔤 用户描述方式**:
- **主要**: "星星之间的线", "星座连线"
- **别名**: "关系线", "星图连接"

**📍 代码位置**:
- **组件文件**: `src/components/Constellation.tsx` - 在 `<svg>` 元素内通过 `motion.line` 渲染。
- **状态/逻辑**: `src/store/useStarStore.ts` @ `constellation.connections` - 连线的数据源。
- **生成逻辑**: `src/utils/aiTaggingUtils.ts` @ `generateSmartConnections` - 定义了如何根据标签相似度生成连线。

**🎨 视觉与行为**:
- **外观**: 带有渐变和呼吸效果的发光线条，连接两个星星。当关联的星星被激活时，连线会变亮，并有光点流动效果。线的颜色基于其关联的标签（如“love”是粉色，“career”是金色）。
- **行为**: 纯视觉元素，无直接交互。

**🛠️ 修改指引**:
- **改连线逻辑**: 修改 `src/utils/aiTaggingUtils.ts` 中的 `calculateStarSimilarity` 或 `generateSmartConnections` 函数。
- **改连线样式/颜色**: 修改 `src/components/Constellation.tsx` 中 `<motion.line>` 的 `stroke` 和 `strokeWidth` 属性，以及 `linearGradient` 的颜色逻辑。

### 4. 创建星星加载动画
**🔤 用户描述方式**:
- **主要**: "正在生成星星的动画", "等待时的光圈"
- **别名**: "加载指示器"

**📍 代码位置**:
- **组件文件**: `src/components/Constellation.tsx` - 在 `isLoading && pendingStarPosition` 条件下渲染。
- **状态/逻辑**: `src/store/useStarStore.ts` @ `isLoading`, `pendingStarPosition` - 控制其显示和位置。

**🎨 视觉与行为**:
- **外观**: 在用户点击的位置出现一个带有呼吸和旋转动画的星芒图标。
- **行为**: 当用户提交问题后、星星数据返回前显示，表示正在处理。

**🛠️ 修改指引**:
- **改动画图标**: 修改 `src/components/Constellation.tsx` 中使用的 `<StarRayIcon />` 组件及其属性。
- **改动画效果**: 调整 `motion.div` 的 `animate` 和 `transition` 属性。

---

## 用户输入
> **模块描述**: 应用底部的核心输入区域，用户通过这里提出问题以创建新的星星。
> **主组件文件**: `src/components/ConversationDrawer.tsx`

### 1. 底部输入抽屉
**🔤 用户描述方式**:
- **主要**: "底部的输入框", "聊天框"
- **别名**: "提问的地方", "对话抽屉"

**📍 代码位置**:
- **组件文件**: `src/components/ConversationDrawer.tsx` - 整个组件负责此功能。
- **集成**: `src/App.tsx` - `<ConversationDrawer isOpen={true} ... />`

**🎨 视觉与行为**:
- **外观**: 固定在屏幕底部，半透明模糊背景，包含输入框和按钮。
- **行为**: 作为一个整体，从屏幕底部滑入。

**🛠️ 修改指引**:
- **改整体布局/动画**: 修改 `src/components/ConversationDrawer.tsx` 中最外层 `motion.div` 的样式和 `transition` 属性。

### 2. 问题输入框
**🔤 用户描述方式**:
- **主要**: "输入问题的地方", "文本框"
- **别名**: "textarea"

**📍 代码位置**:
- **组件文件**: `src/components/ConversationDrawer.tsx` - `<textarea ref={textareaRef} ... />`
- **状态/逻辑**: `src/components/ConversationDrawer.tsx` @ `useState('inputValue')` - 绑定输入内容。

**🎨 视觉与行为**:
- **外观**: 位于抽屉中央的透明背景文本区域，可根据内容自动增高。
- **文本/占位符**: "向星空提出你的问题..." 或 "询问任何问题"
- **行为**: 用户输入时更新 `inputValue` 状态。按回车键（非Shift）会触发 `handleSend` 函数发送问题。

**🛠️ 修改指引**:
- **改占位符文本**: 修改 `<textarea>` 的 `placeholder` 属性。
- **改输入行为**: 调整 `onChange` 和 `onKeyPress` 事件处理器。
- **改样式**: 调整 `src/components/ConversationDrawer.tsx` 中 `<textarea>` 的Tailwind类。

### 3. 发送/创建星星按钮
**🔤 用户描述方式**:
- **主要**: "发送按钮", "那个星星图标的按钮"
- **别名**: "提交问题"

**📍 代码位置**:
- **组件文件**: `src/components/ConversationDrawer.tsx` - `<motion.button key="send" ...>`
- **状态/逻辑**: `src/components/ConversationDrawer.tsx` @ `handleSend` - 点击后触发的函数。

**🎨 视觉与行为**:
- **外观**: 位于输入框右侧的大圆形按钮。当输入框有文字时，按钮变为紫色，内部的星芒图标会有动画。无文字时为灰色静态图标。
- **行为**: 仅在输入框有内容时可点击。点击后调用 `handleSend`，后者再调用 `useStarStore` 的 `addStar` 方法来创建星星。

**🛠️ 修改指引**:
- **改图标**: 修改 `<StarRayIcon />` 的属性或替换该组件。
- **改颜色/状态**: 调整按钮的条件渲染逻辑和Tailwind类。
- **改点击逻辑**: 修改 `handleSend` 函数的内容。

### 4. 灵感提示胶囊
**🔤 用户描述方式**:
- **主要**: "推荐的问题", "那些小按钮"
- **别名**: "问题建议", "快速提问"

**📍 代码位置**:
- **组件文件**: `src/components/ConversationDrawer.tsx` - 在 `SUGGESTION_CARDS.map(...)` 中渲染。
- **数据源**: `src/components/ConversationDrawer.tsx` @ `SUGGESTION_CARDS` - 定义了提示问题的内容。

**🎨 视觉与行为**:
- **外观**: 位于输入抽屉上方的一行可横向滚动的胶囊状按钮。
- **文本/占位符**: "我真正想要的是什么？", "如何建立更深的连接？" 等。
- **行为**: 仅在对话历史为空且输入框无内容时显示。点击一个胶囊会将其文本填入输入框并聚焦。

**🛠️ 修改指引**:
- **改提示问题**: 修改 `SUGGESTION_CARDS` 数组的内容。
- **改样式**: 调整 `motion.button` 的Tailwind类。
- **改点击行为**: 修改 `handleSuggestionClick` 函数。

---

## 功能面板与模态框

### 1. AI 配置面板
> **模块描述**: 允许用户配置连接AI服务（如OpenAI, Gemini）所需的API Key和Endpoint。
> **主组件文件**: `src/components/AIConfigPanel.tsx`

#### 1.1 打开配置面板的设置按钮
**🔤 用户描述方式**:
- **主要**: "右上角的设置按钮", "齿轮图标"
- **别名**: "AI设置", "配置API"

**📍 代码位置**:
- **组件文件**: `src/App.tsx` - `<button className="cosmic-button rounded-full..." ...>`
- **状态/逻辑**: `src/App.tsx` @ `handleOpenConfig` - 控制面板打开的函数。

**🎨 视觉与行为**:
- **外观**: 位于屏幕右上角，包含一个齿轮图标的圆形按钮。
- **行为**: 点击后调用 `handleOpenConfig`，将 `isConfigOpen` 状态设为 `true`，从而显示 `AIConfigPanel`。

**🛠️ 修改指引**:
- **改图标**: 修改 `src/App.tsx` 中的 `<Settings />` lucide-react图标。
- **改位置/样式**: 调整 `src/App.tsx` 中该按钮容器 `div` 的样式。

#### 1.2 配置面板主体
**🔤 用户描述方式**:
- **主要**: "AI设置弹窗", "API配置页面"
- **别名**: "模型设置"

**📍 代码位置**:
- **组件文件**: `src/components/AIConfigPanel.tsx` - 整个组件负责此功能。
- **状态/逻辑**: `src/utils/aiTaggingUtils.ts` @ `setAIConfig`, `getAIConfig`, `validateAIConfig`

**🎨 视觉与行为**:
- **外观**: 一个居中的模态框，包含标题、提供商选择、多个输入框和操作按钮。
- **子元素**:
    - **API 提供商按钮**: "OpenAI / 兼容服务" 和 "Google Gemini" 两个按钮，用于切换配置模板。
    - **API Key 输入框**: 类型为 `password` 的输入框。
    - **API Endpoint 输入框**: 文本输入框。
    - **模型名称输入框**: 文本输入框。
    - **验证按钮**: 点击后调用 `handleValidate` 测试配置有效性。
    - **保存按钮**: 点击后调用 `handleSave` 保存配置到LocalStorage。
    - **导入/导出按钮**: 允许用户以JSON文件形式导入或导出配置。
    - **关闭按钮**: 右上角的 'X' 按钮。
- **行为**: 用户填写信息后，可以验证其有效性，然后保存。配置成功后，应用将使用此配置进行AI调用。

**🛠️ 修改指引**:
- **改输入框逻辑**: 修改 `src/components/AIConfigPanel.tsx` 中 `onChange` 事件处理器。
- **改验证/保存逻辑**: 修改 `handleValidate` 和 `handleSave` 函数，以及 `src/utils/aiTaggingUtils.ts` 中的相关函数。
- **改UI布局**: 编辑 `src/components/AIConfigPanel.tsx` 的JSX结构。

### 2. 星星收藏册
> **模块描述**: 一个模态框，以卡片或列表形式展示用户已创建的所有星星。
> **主组件文件**: `src/components/StarCollection.tsx`

#### 2.1 打开收藏册的按钮
**🔤 用户描述方式**:
- **主要**: "左上角的收藏按钮", "那个有本书的按钮"
- **别名**: "我的星星", "星星列表"

**📍 代码位置**:
- **组件文件**: `src/components/CollectionButton.tsx`
- **集成**: `src/App.tsx` - `<CollectionButton onClick={handleOpenCollection} />`

**🎨 视觉与行为**:
- **外观**: 位于屏幕左上角，包含一本书的图标和一个显示星星数量的角标。
- **文本/占位符**: "Star Collection"
- **行为**: 点击后调用 `handleOpenCollection`，将 `isCollectionOpen` 设为 `true`，显示 `StarCollection` 面板。

**🛠️ 修改指引**:
- **改文本/图标**: 修改 `src/components/CollectionButton.tsx` 的JSX。
- **改角标逻辑**: 角标数量由 `useStarStore` 的 `constellation.stars.length` 决定。

#### 2.2 收藏册面板主体
**🔤 用户描述方式**:
- **主要**: "星星收藏册弹窗", "所有星星的列表"
- **别名**: "我的星图"

**📍 代码位置**:
- **组件文件**: `src/components/StarCollection.tsx`
- **卡片组件**: `src/components/StarCard.tsx` - 用于展示单个星星。

**🎨 视觉与行为**:
- **外观**: 一个占据大部分屏幕的模态框，顶部有控制栏，主体区域展示星星卡片。
- **子元素**:
    - **搜索框**: 允许用户根据问题或答案的关键词筛选星星。
    - **过滤器**: 下拉菜单，可按 "All Stars", "Special Stars", "Recent" 筛选。
    - **视图切换**: "Grid" 和 "List" 两个按钮，用于切换卡片网格布局和列表布局。
    - **星星卡片 (`StarCard`)**: 每个卡片代表一颗星星，可点击翻转查看背面详情。卡片正面是基于星星ID生成的程序化视觉效果（行星或多种样式的恒星）。
    - **右键菜单**: 在面板空白处右键单击，可以触发“灵感卡片”。

**🛠️ 修改指引**:
- **改搜索/过滤逻辑**: 修改 `src/components/StarCollection.tsx` 中的 `filteredStars` 计算逻辑。
- **改卡片外观**: `StarCard.tsx` 是关键文件。修改其中的SVG和Canvas绘制逻辑可以改变星星卡片的视觉效果。
- **改卡片翻转行为**: 修改 `StarCollection.tsx` 中的 `handleCardFlip` 函数。

### 3. 星星详情面板
> **模块描述**: 当用户在主星座图中点击一颗星星时弹出的详细信息面板。
> **主组件文件**: `src/components/StarDetail.tsx`

**🔤 用户描述方式**:
- **主要**: "星星的详细信息", "点击星星后弹出的卡片"
- **别名**: "星星详情页"

**📍 代码位置**:
- **组件文件**: `src/components/StarDetail.tsx`
- **状态/逻辑**: `src/store/useStarStore.ts` @ `activeStarId` - 控制此面板的显示和内容。

**🎨 视觉与行为**:
- **外观**: 一个居中的模态框，顶部是该星星的AI生成图像，下方是详细信息。
- **子元素**:
    - **星星图像**: 显示 `activeStar.imageUrl`。
    - **类别标签**: 显示星星的主要类别，如 "PERSONAL GROWTH"。
    - **问题和回答**: 显示用户的问题和AI的回答。
    - **主题标签**: 显示与星星关联的标签。
    - **编辑标签按钮**: 点击后进入标签编辑模式。
    - **标签编辑器**: 允许用户添加或删除标签，并提供建议标签。
    - **相连的星星列表**: 显示与当前星星有连接的其他星星。
    - **情感基调**: 显示分析出的情感基调。
    - **分享/保存按钮**: 用于未来的分享和保存功能。

**🛠️ 修改指引**:
- **改布局/样式**: 编辑 `src/components/StarDetail.tsx` 的JSX和Tailwind类。
- **改标签编辑逻辑**: 修改 `startEditingTags`, `saveTagChanges` 等函数，以及 `useStarStore` 中的 `updateStarTags`。
- **改分享/保存行为**: 修改 `handleShare` 和 `handleSave` 函数。

### 4. 灵感卡片
> **模块描述**: 通过双击或右键单击星空背景触发的卡片，提供一个随机的深刻问题，并模拟"答案之书"给出一个简短回答，引导用户创造新的星星。
> **主组件文件**: `src/components/InspirationCard.tsx`

**🔤 用户描述方式**:
- **主要**: "弹出来的那个问题卡片", "答案之书"
- **别名**: "随机问题", "摘星卡"

**📍 代码位置**:
- **组件文件**: `src/components/InspirationCard.tsx`
- **状态/逻辑**: `src/store/useStarStore.ts` @ `currentInspirationCard`, `drawInspirationCard`
- **数据源**: `src/utils/inspirationCards.ts` (问题) 和 `src/utils/bookOfAnswers.ts` (答案)。

**🎨 视觉与行为**:
- **外观**: 一个居中的、可翻转的卡片模态框。
- **正面**: 带有星空和星芒的装饰性设计，提示用户“翻开卡片，宇宙会回答你”。
- **背面**:
    - 显示一个来自“答案之书”的简短、神秘的回答（如“是的，毫无疑问。”）。
    - 显示一句对该答案的哲学反思。
    - 底部有一个输入框，允许用户基于这个答案提出自己的困惑或问题。
- **行为**:
    - 点击卡片会触发翻转动画。
    - 点击背景遮罩会关闭卡片。
    - 在背面的输入框输入问题并发送，会使用该问题创建一颗新的星星。

**🛠️ 修改指引**:
- **改问题库**: 编辑 `src/utils/inspirationCards.ts` 中的 `INSPIRATION_CARDS` 数组。
- **改答案库**: 编辑 `src/utils/bookOfAnswers.ts` 中的 `answers` 数组。
- **改卡片设计**: 修改 `src/components/InspirationCard.tsx` 的JSX和CSS类（`star-card-*`）。
- **改输入行为**: 修改 `handleSendMessage` 函数。

### 5. 星座模板选择器
> **模块描述**: 允许用户选择一个预设的星座模板作为初始星图，例如十二星座。
> **主组件文件**: `src/components/ConstellationSelector.tsx`

#### 5.1 打开模板选择器的按钮
**🔤 用户描述方式**:
- **主要**: "左上角的选星座按钮"
- **别名**: "模板按钮", "更换星座"

**📍 代码位置**:
- **组件文件**: `src/components/TemplateButton.tsx`
- **集成**: `src/App.tsx` - `<TemplateButton onClick={handleOpenTemplateSelector} />`

**🎨 视觉与行为**:
- **外观**: 位于左上角，收藏按钮下方。包含一个星芒图标。
- **文本/占位符**: 如果未选择模板，显示“选择星座”。如果已选择，显示“更换星座”和当前模板名称。
- **行为**: 点击后调用 `handleOpenTemplateSelector`，将 `isTemplateSelectorOpen` 设为 `true`，显示 `ConstellationSelector` 面板。

**🛠️ 修改指引**:
- **改文本/图标**: 修改 `src/components/TemplateButton.tsx` 的JSX。
- **改状态显示**: 文本变化逻辑由 `useStarStore` 的 `hasTemplate` 和 `templateInfo` 状态驱动。

#### 5.2 模板选择器面板
**🔤 用户描述方式**:
- **主要**: "选星座的弹窗", "模板列表"
- **别名**: "星座库"

**📍 代码位置**:
- **组件文件**: `src/components/ConstellationSelector.tsx`
- **数据源**: `src/utils/constellationTemplates.ts` - 定义了所有可用的星座模板数据。

**🎨 视觉与行为**:
- **外观**: 一个大型模态框，顶部有元素（火、土、风、水）筛选器，主体为模板卡片网格。
- **子元素**:
    - **元素筛选器**: "全部", "火象", "土象"等按钮，用于筛选模板。
    - **模板卡片**: 每个卡片展示一个星座模板的预览图、中英文名、描述和基本信息（星星数、连线数）。
- **行为**:
    - 点击元素按钮会筛选显示的模板。
    - 点击任意模板卡片会调用 `handleSelectTemplate`，后者再调用 `useStarStore` 的 `applyTemplate` 方法，将选中的模板应用到主星座图中，并关闭面板。

**🛠️ 修改指引**:
- **改/添加模板**: 编辑 `src/utils/constellationTemplates.ts` 中的 `ZODIAC_TEMPLATES` 数组。
- **改卡片布局/样式**: 修改 `src/components/ConstellationSelector.tsx` 中 `motion.div` 的JSX和Tailwind类。
- **改筛选逻辑**: 调整 `filteredTemplates` 的计算逻辑。